2025-09-10 14:34:00.659 |  | INFO     | server:lifespan:49 - FLUX-LLM-OPS开始启动
2025-09-10 14:34:00.660 |  | INFO     | config.get_db:init_create_table:26 - 初始化数据库连接...
2025-09-10 14:34:00.738 |  | INFO     | config.get_db:init_create_table:29 - 数据库连接成功
2025-09-10 14:34:00.739 |  | INFO     | config.get_redis:create_redis_pool:34 - 开始连接redis...
2025-09-10 14:34:00.742 |  | INFO     | config.get_redis:create_redis_pool:47 - redis连接成功
2025-09-10 14:34:00.742 |  | INFO     | config.get_redis:create_redis_pool:34 - 开始连接redis...
2025-09-10 14:34:00.744 |  | INFO     | config.get_redis:create_redis_pool:47 - redis连接成功
2025-09-10 14:34:00.877 |  | INFO     | config.get_scheduler:init_system_scheduler:133 - 开始启动定时任务...
2025-09-10 14:34:00.907 |  | INFO     | config.get_scheduler:init_system_scheduler:141 - 系统初始定时任务加载成功
2025-09-10 14:34:00.923 |  | INFO     | apps.module_llm.chat.llm.llm_probvider:get_instance:38 - Load base model success
2025-09-10 14:34:00.930 |  | INFO     | apps.module_llm.chat.llm.llm_probvider:get_instance:42 - Load base config success
2025-09-10 14:34:01.578 |  | INFO     | apps.module_llm.chat.rag.embedding_provider:get_instance:27 - Load embedding model success
2025-09-10 14:34:02.224 |  | INFO     | server:lifespan:49 - FLUX-LLM-OPS开始启动
2025-09-10 14:34:02.224 |  | INFO     | config.get_db:init_create_table:26 - 初始化数据库连接...
2025-09-10 14:34:02.254 |  | INFO     | server:lifespan:49 - FLUX-LLM-OPS开始启动
2025-09-10 14:34:02.258 |  | INFO     | config.get_db:init_create_table:26 - 初始化数据库连接...
2025-09-10 14:34:02.290 |  | INFO     | server:lifespan:65 - FLUX-LLM-OPS启动成功
2025-09-10 14:34:02.411 |  | INFO     | config.get_db:init_create_table:29 - 数据库连接成功
2025-09-10 14:34:02.411 |  | INFO     | config.get_redis:create_redis_pool:34 - 开始连接redis...
2025-09-10 14:34:02.427 |  | INFO     | config.get_redis:create_redis_pool:47 - redis连接成功
2025-09-10 14:34:02.427 |  | INFO     | config.get_redis:create_redis_pool:34 - 开始连接redis...
2025-09-10 14:34:02.437 |  | INFO     | config.get_db:init_create_table:29 - 数据库连接成功
2025-09-10 14:34:02.437 |  | INFO     | config.get_redis:create_redis_pool:34 - 开始连接redis...
2025-09-10 14:34:02.441 |  | INFO     | config.get_redis:create_redis_pool:47 - redis连接成功
2025-09-10 14:34:02.441 |  | INFO     | config.get_redis:create_redis_pool:34 - 开始连接redis...
2025-09-10 14:34:02.443 |  | INFO     | config.get_redis:create_redis_pool:47 - redis连接成功
2025-09-10 14:34:02.446 |  | INFO     | config.get_redis:create_redis_pool:47 - redis连接成功
2025-09-10 14:34:02.522 |  | INFO     | server:lifespan:49 - FLUX-LLM-OPS开始启动
2025-09-10 14:34:02.522 |  | INFO     | config.get_db:init_create_table:26 - 初始化数据库连接...
2025-09-10 14:34:02.608 |  | INFO     | config.get_scheduler:init_system_scheduler:133 - 开始启动定时任务...
2025-09-10 14:34:02.635 |  | INFO     | config.get_scheduler:init_system_scheduler:141 - 系统初始定时任务加载成功
2025-09-10 14:34:02.638 |  | INFO     | config.get_db:init_create_table:29 - 数据库连接成功
2025-09-10 14:34:02.638 |  | INFO     | config.get_redis:create_redis_pool:34 - 开始连接redis...
2025-09-10 14:34:02.648 |  | INFO     | config.get_redis:create_redis_pool:47 - redis连接成功
2025-09-10 14:34:02.648 |  | INFO     | config.get_redis:create_redis_pool:34 - 开始连接redis...
2025-09-10 14:34:02.658 |  | INFO     | config.get_redis:create_redis_pool:47 - redis连接成功
2025-09-10 14:34:02.655 |  | INFO     | apps.module_llm.chat.llm.llm_probvider:get_instance:38 - Load base model success
2025-09-10 14:34:02.663 |  | INFO     | apps.module_llm.chat.llm.llm_probvider:get_instance:42 - Load base config success
2025-09-10 14:34:02.728 |  | INFO     | config.get_scheduler:init_system_scheduler:133 - 开始启动定时任务...
2025-09-10 14:34:02.852 |  | INFO     | config.get_scheduler:init_system_scheduler:141 - 系统初始定时任务加载成功
2025-09-10 14:34:02.856 |  | INFO     | config.get_scheduler:init_system_scheduler:133 - 开始启动定时任务...
2025-09-10 14:34:02.869 |  | INFO     | apps.module_llm.chat.llm.llm_probvider:get_instance:38 - Load base model success
2025-09-10 14:34:02.876 |  | INFO     | apps.module_llm.chat.llm.llm_probvider:get_instance:42 - Load base config success
2025-09-10 14:34:02.982 |  | INFO     | apps.module_llm.chat.rag.embedding_provider:get_instance:27 - Load embedding model success
2025-09-10 14:34:03.170 |  | INFO     | apps.module_llm.chat.rag.embedding_provider:get_instance:27 - Load embedding model success
2025-09-10 14:34:03.171 |  | INFO     | config.get_scheduler:init_system_scheduler:141 - 系统初始定时任务加载成功
2025-09-10 14:34:03.197 |  | INFO     | apps.module_llm.chat.llm.llm_probvider:get_instance:38 - Load base model success
2025-09-10 14:34:03.208 |  | INFO     | apps.module_llm.chat.llm.llm_probvider:get_instance:42 - Load base config success
2025-09-10 14:34:03.319 |  | INFO     | server:lifespan:65 - FLUX-LLM-OPS启动成功
2025-09-10 14:34:03.542 |  | INFO     | apps.module_llm.chat.rag.embedding_provider:get_instance:27 - Load embedding model success
2025-09-10 14:34:03.577 |  | INFO     | server:lifespan:65 - FLUX-LLM-OPS启动成功
2025-09-10 14:34:03.885 |  | INFO     | server:lifespan:65 - FLUX-LLM-OPS启动成功
2025-09-10 14:34:20.741 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-10 14:34:20.742 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-10 14:34:20.781 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-10 14:34:20.799 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-10 14:34:20.799 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-10 14:34:20.801 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-10 14:34:21.819 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: e014a0c7-f68a-439e-b750-1f927e242b96, Total Tokens: 832, Prompt Tokens: 811, Completion Tokens: 21
2025-09-10 14:34:21.832 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-10 14:34:21.832 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: e014a0c7-f68a-439e-b750-1f927e242b96
2025-09-10 14:34:21.834 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': True} ---
2025-09-10 14:34:21.834 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-10 14:34:21.835 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-10 14:34:21.835 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-10 14:34:21.837 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-10 14:34:21.837 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: True
2025-09-10 14:34:29.185 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-10 14:34:29.186 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-10 14:34:29.186 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 用饼图形式展示不同订单类型的数量
2025-09-10 14:34:29.187 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-10 14:34:29.187 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-10 14:34:29.187 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 468)
2025-09-10 14:34:29.188 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'ZHANGXY', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiNDA2N2EyOTItZGI3My00MmYxLTljOTgtOTQyYzc4YzgzYzRkIiwiaWF0IjoxNzU3NDg1OTQ5LCJleHAiOjE3NTc0ODY1NDl9.B2agcbE5QvZPDNNymmR-zW9aAnaU1kPVZDXNRbmyUH0', 'Signature': 'f45fa64c389f206af7d0b3aa04caea39', 'Message': '%E7%94%A8%E9%A5%BC%E5%9B%BE%E5%BD%A2%E5%BC%8F%E5%B1%95%E7%A4%BA%E4%B8%8D%E5%90%8C%E8%AE%A2%E5%8D%95%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%95%B0%E9%87%8F'}
2025-09-10 14:34:35.766 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-10 14:34:35.777 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 8 (<= 1000), 执行全量查询.
2025-09-10 14:34:35.784 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/c658c119-5026-4a34-b515-7bfbe87d4d69.xlsx
2025-09-10 14:34:35.796 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/c658c119-5026-4a34-b515-7bfbe87d4d69.xlsx
2025-09-10 14:34:35.797 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-10 14:34:35.798 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-10 14:34:35.800 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-10 14:34:35.800 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-10 14:34:35.802 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-10 14:34:35.803 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-10 14:34:36.673 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: e014a0c7-f68a-439e-b750-1f927e242b96, Total Tokens: 451, Prompt Tokens: 436, Completion Tokens: 15
2025-09-10 14:34:36.683 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-10 14:34:36.684 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: e014a0c7-f68a-439e-b750-1f927e242b96
2025-09-10 14:34:36.685 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{\n  "orderNo": "订单数量"\n}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 15, 'prompt_tokens': 436, 'total_tokens': 451, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-37f586ee-cb8b-477d-b0a0-646d50ab33e0', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--bdcfd1f0-cf03-4b41-a074-df0ed16b4e79-0' usage_metadata={'input_tokens': 436, 'output_tokens': 15, 'total_tokens': 451, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-10 14:34:36.686 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {'orderNo': '订单数量'}
2025-09-10 14:34:36.686 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共8行）:
| 订单类型 | 订单数量 |
|---|---|
| 采购退货 | [77](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiA3N319fQ==) |
| 取样出库 | [401](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiA0MDF9fX0=) |
| 调拨出库 | [117](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAxMTd9fX0=) |
| 其他出库 | [286](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAyODZ9fX0=) |
| 手工出库单 | [114](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAxMTR9fX0=) |
| 生产领料出库 | [185](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAxODV9fX0=) |
| 委外出库 | [66](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiA2Nn19fQ==) |
| 销售出库 | [165](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAxNjV9fX0=) |
2025-09-10 14:34:36.687 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 订单类型 | 订单数量 |
|---|---|
| 采购退货 | [77](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiA3N319fQ==) |
| 取样出库 | [401](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiA0MDF9fX0=) |
| 调拨出库 | [117](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAxMTd9fX0=) |
| 其他出库 | [286](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAyODZ9fX0=) |
| 手工出库单 | [114](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAxMTR9fX0=) |
| 生产领料出库 | [185](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAxODV9fX0=) |
| 委外出库 | [66](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiA2Nn19fQ==) |
| 销售出库 | [165](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAxNjV9fX0=) | ---
2025-09-10 14:34:36.687 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-10 14:34:38.828 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: e014a0c7-f68a-439e-b750-1f927e242b96, Total Tokens: 1624, Prompt Tokens: 1513, Completion Tokens: 111
2025-09-10 14:34:38.838 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-10 14:34:38.838 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: e014a0c7-f68a-439e-b750-1f927e242b96
2025-09-10 14:34:38.839 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:186 - --- Chart Agent: Agent thinking ret: content='' additional_kwargs={'tool_calls': [{'id': 'call_358e4cbbf1664e2b9b6778', 'function': {'arguments': '{"series_data": {"采购退货": 77, "取样出库": 401, "调拨出库": 117, "其他出库": 286, "手工出库单": 114, "生产领料出库": 185, "委外出库": 66, "销售出库": 165}, "title": "不同订单类型的数量"}', 'name': 'generate_pie_chart_json'}, 'type': 'function', 'index': 0}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 111, 'prompt_tokens': 1513, 'total_tokens': 1624, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-2d3785a0-84d4-4844-8157-358fe6eddc66', 'service_tier': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--bae81069-1fca-40f1-9d7a-47c6d4223fef-0' tool_calls=[{'name': 'generate_pie_chart_json', 'args': {'series_data': {'采购退货': 77, '取样出库': 401, '调拨出库': 117, '其他出库': 286, '手工出库单': 114, '生产领料出库': 185, '委外出库': 66, '销售出库': 165}, 'title': '不同订单类型的数量'}, 'id': 'call_358e4cbbf1664e2b9b6778', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1513, 'output_tokens': 111, 'total_tokens': 1624, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}} ---
2025-09-10 14:34:38.839 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:188 - --- Leave node: Chart Agent ---
2025-09-10 14:34:38.842 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-10 14:34:38.842 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.tool_executor:_execute_tools:131 - [Tool Executor] 即将调用工具: generate_pie_chart_json, 参数: {'series_data': {'采购退货': 77, '取样出库': 401, '调拨出库': 117, '其他出库': 286, '手工出库单': 114, '生产领料出库': 185, '委外出库': 66, '销售出库': 165}, 'title': '不同订单类型的数量'}, call_id: call_358e4cbbf1664e2b9b6778
2025-09-10 14:34:38.846 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.tool_executor:_execute_tools:146 - [Tool Executor] 工具返回执行结果：{'status': 'success', 'data': {'pie_json_result': '{"animation": true, "animationThreshold": 2000, "animationDuration": 1000, "animationEasing": "cubicOut", "animationDelay": 0, "animationDurationUpdate": 300, "animationEasingUpdate": "cubicOut", "animationDelayUpdate": 0, "aria": {"enabled": false}, "color": ["#5470c6", "#91cc75", "#fac858", "#ee6666", "#73c0de", "#3ba272", "#fc8452", "#9a60b4", "#ea7ccc"], "series": [{"type": "pie", "colorBy": "data", "legendHoverLink": true, "selectedMode": false, "selectedOffset": 10, "clockwise": true, "startAngle": 90, "minAngle": 0, "minShowLabelAngle": 0, "avoidLabelOverlap": true, "stillShowZeroSum": true, "percentPrecision": 2, "showEmptyCircle": true, "emptyCircleStyle": {"color": "lightgray", "borderColor": "#000", "borderWidth": 0, "borderType": "solid", "borderDashOffset": 0, "borderCap": "butt", "borderJoin": "bevel", "borderMiterLimit": 10, "opacity": 1}, "data": [{"name": "采购退货", "value": 77}, {"name": "取样出库", "value": 401}, {"name": "调拨出库", "value": 117}, {"name": "其他出库", "value": 286}, {"name": "手工出库单", "value": 114}, {"name": "生产领料出库", "value": 185}, {"name": "委外出库", "value": 66}, {"name": "销售出库", "value": 165}], "radius": "50%", "center": ["50%", "50%"], "label": {"show": true, "margin": 8, "formatter": "{b}: {c}", "valueAnimation": false}, "labelLine": {"show": true, "showAbove": false, "length": 15, "length2": 15, "smooth": false, "minTurnAngle": 90, "maxSurfaceAngle": 90}, "rippleEffect": {"show": true, "brushType": "stroke", "scale": 2.5, "period": 4}}], "legend": [{"data": ["采购退货", "取样出库", "调拨出库", "其他出库", "手工出库单", "生产领料出库", "委外出库", "销售出库"], "selected": {}, "show": true, "padding": 5, "itemGap": 10, "itemWidth": 25, "itemHeight": 14, "backgroundColor": "transparent", "borderColor": "#ccc", "borderRadius": 0, "pageButtonItemGap": 5, "pageButtonPosition": "end", "pageFormatter": "{current}/{total}", "pageIconColor": "#2f4554", "pageIconInactiveColor": "#aaa", "pageIconSize": 15, "animationDurationUpdate": 800, "selector": false, "selectorPosition": "auto", "selectorItemGap": 7, "selectorButtonGap": 10}], "tooltip": {"show": true, "trigger": "axis", "triggerOn": "mousemove|click", "axisPointer": {"type": "line"}, "showContent": true, "alwaysShowContent": false, "showDelay": 0, "hideDelay": 100, "enterable": false, "confine": true, "appendToBody": false, "transitionDuration": 0.4, "textStyle": {"fontSize": 14}, "borderWidth": 0, "padding": 5, "order": "seriesAsc"}, "title": [{"show": true, "text": "不同订单类型的数量", "target": "blank", "subtarget": "blank", "padding": 5, "itemGap": 10, "textAlign": "auto", "textVerticalAlign": "auto", "triggerEvent": false}]}'}, 'error_message': None}
2025-09-10 14:34:38.857 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.tool_executor:_execute_tools:171 - Add Tool usage ret: is_success=True message='新增成功' result=None
2025-09-10 14:34:38.857 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.tool_executor:_execute_tools:172 - Successfully scheduled tool usage db write for chat_id: e014a0c7-f68a-439e-b750-1f927e242b96
2025-09-10 14:34:38.858 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:93 - --- ECharts Tool Executor: ECharts工具Dict: {'status': 'success', 'data': {'pie_json_result': '{"animation": true, "animationThreshold": 2000, "animationDuration": 1000, "animationEasing": "cubicOut", "animationDelay": 0, "animationDurationUpdate": 300, "animationEasingUpdate": "cubicOut", "animationDelayUpdate": 0, "aria": {"enabled": false}, "color": ["#5470c6", "#91cc75", "#fac858", "#ee6666", "#73c0de", "#3ba272", "#fc8452", "#9a60b4", "#ea7ccc"], "series": [{"type": "pie", "colorBy": "data", "legendHoverLink": true, "selectedMode": false, "selectedOffset": 10, "clockwise": true, "startAngle": 90, "minAngle": 0, "minShowLabelAngle": 0, "avoidLabelOverlap": true, "stillShowZeroSum": true, "percentPrecision": 2, "showEmptyCircle": true, "emptyCircleStyle": {"color": "lightgray", "borderColor": "#000", "borderWidth": 0, "borderType": "solid", "borderDashOffset": 0, "borderCap": "butt", "borderJoin": "bevel", "borderMiterLimit": 10, "opacity": 1}, "data": [{"name": "采购退货", "value": 77}, {"name": "取样出库", "value": 401}, {"name": "调拨出库", "value": 117}, {"name": "其他出库", "value": 286}, {"name": "手工出库单", "value": 114}, {"name": "生产领料出库", "value": 185}, {"name": "委外出库", "value": 66}, {"name": "销售出库", "value": 165}], "radius": "50%", "center": ["50%", "50%"], "label": {"show": true, "margin": 8, "formatter": "{b}: {c}", "valueAnimation": false}, "labelLine": {"show": true, "showAbove": false, "length": 15, "length2": 15, "smooth": false, "minTurnAngle": 90, "maxSurfaceAngle": 90}, "rippleEffect": {"show": true, "brushType": "stroke", "scale": 2.5, "period": 4}}], "legend": [{"data": ["采购退货", "取样出库", "调拨出库", "其他出库", "手工出库单", "生产领料出库", "委外出库", "销售出库"], "selected": {}, "show": true, "padding": 5, "itemGap": 10, "itemWidth": 25, "itemHeight": 14, "backgroundColor": "transparent", "borderColor": "#ccc", "borderRadius": 0, "pageButtonItemGap": 5, "pageButtonPosition": "end", "pageFormatter": "{current}/{total}", "pageIconColor": "#2f4554", "pageIconInactiveColor": "#aaa", "pageIconSize": 15, "animationDurationUpdate": 800, "selector": false, "selectorPosition": "auto", "selectorItemGap": 7, "selectorButtonGap": 10}], "tooltip": {"show": true, "trigger": "axis", "triggerOn": "mousemove|click", "axisPointer": {"type": "line"}, "showContent": true, "alwaysShowContent": false, "showDelay": 0, "hideDelay": 100, "enterable": false, "confine": true, "appendToBody": false, "transitionDuration": 0.4, "textStyle": {"fontSize": 14}, "borderWidth": 0, "padding": 5, "order": "seriesAsc"}, "title": [{"show": true, "text": "不同订单类型的数量", "target": "blank", "subtarget": "blank", "padding": 5, "itemGap": 10, "textAlign": "auto", "textVerticalAlign": "auto", "triggerEvent": false}]}'}, 'error_message': None} ---
2025-09-10 14:34:38.858 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:101 - --- Leave node: ECharts Tool Executor ---
2025-09-10 14:34:38.861 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-10 14:34:38.861 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-10 14:34:38.862 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-10 14:34:38.864 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-10 14:34:38.881 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 93 ---
2025-09-10 14:34:38.894 | a2cb7cdf53d34954bc51cfe18ffe63c9 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 94 ---
2025-09-10 14:34:38.894 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-10 14:34:38.982 | a2cb7cdf53d34954bc51cfe18ffe63c9 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-10 14:56:27.993 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-10 14:56:27.994 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-10 14:56:28.047 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-10 14:56:28.064 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-10 14:56:28.065 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-10 14:56:28.068 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-10 14:56:29.296 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34, Total Tokens: 835, Prompt Tokens: 814, Completion Tokens: 21
2025-09-10 14:56:29.310 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-10 14:56:29.311 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34
2025-09-10 14:56:29.312 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': True} ---
2025-09-10 14:56:29.313 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-10 14:56:29.314 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-10 14:56:29.314 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-10 14:56:29.316 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-10 14:56:29.316 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: True
2025-09-10 14:56:29.356 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-10 14:56:29.356 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-10 14:56:29.357 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 用饼图形式展示不同订单类型的数量
2025-09-10 14:56:29.357 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-10 14:56:29.358 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-10 14:56:29.358 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 468)
2025-09-10 14:56:29.359 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'ZHANGXY', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiMmNkOGY3M2UtM2ZkZi00NjQ1LWE4YjMtODZhMWY3Y2ZiZDMxIiwiaWF0IjoxNzU3NDg3MjY5LCJleHAiOjE3NTc0ODc4Njl9.XmyUPgo-L_r1MSsx4rddlSY02cDGOh6ObqYcgimplDw', 'Signature': '03658f06541489a6b4accb1d6f091f76', 'Message': '%E7%94%A8%E9%A5%BC%E5%9B%BE%E5%BD%A2%E5%BC%8F%E5%B1%95%E7%A4%BA%E4%B8%8D%E5%90%8C%E8%AE%A2%E5%8D%95%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%95%B0%E9%87%8F'}
2025-09-10 14:56:35.843 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-10 14:56:35.854 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 8 (<= 1000), 执行全量查询.
2025-09-10 14:56:35.861 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/1ae9bb5b-3748-4a43-a780-c6ef2194e4c5.xlsx
2025-09-10 14:56:35.873 | 7d9af06de14640c688076b455e5ae07a | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/1ae9bb5b-3748-4a43-a780-c6ef2194e4c5.xlsx
2025-09-10 14:56:35.873 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-10 14:56:35.874 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-10 14:56:35.876 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-10 14:56:35.876 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-10 14:56:35.878 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-10 14:56:35.879 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-10 14:56:36.529 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34, Total Tokens: 729, Prompt Tokens: 724, Completion Tokens: 5
2025-09-10 14:56:36.539 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-10 14:56:36.540 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34
2025-09-10 14:56:36.542 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 724, 'total_tokens': 729, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-3ca89ad5-5e23-48ba-8246-ba1936838a3f', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--d2e01a4f-557c-4ff3-815d-4b2bce726902-0' usage_metadata={'input_tokens': 724, 'output_tokens': 5, 'total_tokens': 729, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-10 14:56:36.542 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-10 14:56:36.542 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-10 14:56:36.543 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共8行）:
| 订单类型 | 订单数量 |
|---|---|
| 采购退货 | 77 |
| 取样出库 | 401 |
| 调拨出库 | 117 |
| 其他出库 | 286 |
| 手工出库单 | 114 |
| 生产领料出库 | 185 |
| 委外出库 | 66 |
| 销售出库 | 165 |
2025-09-10 14:56:36.543 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 订单类型 | 订单数量 |
|---|---|
| 采购退货 | 77 |
| 取样出库 | 401 |
| 调拨出库 | 117 |
| 其他出库 | 286 |
| 手工出库单 | 114 |
| 生产领料出库 | 185 |
| 委外出库 | 66 |
| 销售出库 | 165 | ---
2025-09-10 14:56:36.543 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-10 14:56:38.233 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34, Total Tokens: 1626, Prompt Tokens: 1515, Completion Tokens: 111
2025-09-10 14:56:38.241 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-10 14:56:38.241 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34
2025-09-10 14:56:38.242 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:186 - --- Chart Agent: Agent thinking ret: content='' additional_kwargs={'tool_calls': [{'id': 'call_d553dcdd26b64f0484209c', 'function': {'arguments': '{"series_data": {"采购退货": 77, "取样出库": 401, "调拨出库": 117, "其他出库": 286, "手工出库单": 114, "生产领料出库": 185, "委外出库": 66, "销售出库": 165}, "title": "不同订单类型的数量"}', 'name': 'generate_pie_chart_json'}, 'type': 'function', 'index': 0}], 'refusal': None} response_metadata={'token_usage': {'completion_tokens': 111, 'prompt_tokens': 1515, 'total_tokens': 1626, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-12d52424-fe6f-4be4-8f4b-bd56691530af', 'service_tier': None, 'finish_reason': 'tool_calls', 'logprobs': None} id='run--53ec3ccc-85bb-4eca-b320-60c1d1facd5d-0' tool_calls=[{'name': 'generate_pie_chart_json', 'args': {'series_data': {'采购退货': 77, '取样出库': 401, '调拨出库': 117, '其他出库': 286, '手工出库单': 114, '生产领料出库': 185, '委外出库': 66, '销售出库': 165}, 'title': '不同订单类型的数量'}, 'id': 'call_d553dcdd26b64f0484209c', 'type': 'tool_call'}] usage_metadata={'input_tokens': 1515, 'output_tokens': 111, 'total_tokens': 1626, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}} ---
2025-09-10 14:56:38.242 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:188 - --- Leave node: Chart Agent ---
2025-09-10 14:56:38.244 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-10 14:56:38.244 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.tool_executor:_execute_tools:131 - [Tool Executor] 即将调用工具: generate_pie_chart_json, 参数: {'series_data': {'采购退货': 77, '取样出库': 401, '调拨出库': 117, '其他出库': 286, '手工出库单': 114, '生产领料出库': 185, '委外出库': 66, '销售出库': 165}, 'title': '不同订单类型的数量'}, call_id: call_d553dcdd26b64f0484209c
2025-09-10 14:56:38.249 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.tool_executor:_execute_tools:146 - [Tool Executor] 工具返回执行结果：{'status': 'success', 'data': {'pie_json_result': '{"animation": true, "animationThreshold": 2000, "animationDuration": 1000, "animationEasing": "cubicOut", "animationDelay": 0, "animationDurationUpdate": 300, "animationEasingUpdate": "cubicOut", "animationDelayUpdate": 0, "aria": {"enabled": false}, "color": ["#5470c6", "#91cc75", "#fac858", "#ee6666", "#73c0de", "#3ba272", "#fc8452", "#9a60b4", "#ea7ccc"], "series": [{"type": "pie", "colorBy": "data", "legendHoverLink": true, "selectedMode": false, "selectedOffset": 10, "clockwise": true, "startAngle": 90, "minAngle": 0, "minShowLabelAngle": 0, "avoidLabelOverlap": true, "stillShowZeroSum": true, "percentPrecision": 2, "showEmptyCircle": true, "emptyCircleStyle": {"color": "lightgray", "borderColor": "#000", "borderWidth": 0, "borderType": "solid", "borderDashOffset": 0, "borderCap": "butt", "borderJoin": "bevel", "borderMiterLimit": 10, "opacity": 1}, "data": [{"name": "采购退货", "value": 77}, {"name": "取样出库", "value": 401}, {"name": "调拨出库", "value": 117}, {"name": "其他出库", "value": 286}, {"name": "手工出库单", "value": 114}, {"name": "生产领料出库", "value": 185}, {"name": "委外出库", "value": 66}, {"name": "销售出库", "value": 165}], "radius": "50%", "center": ["50%", "50%"], "label": {"show": true, "margin": 8, "formatter": "{b}: {c}", "valueAnimation": false}, "labelLine": {"show": true, "showAbove": false, "length": 15, "length2": 15, "smooth": false, "minTurnAngle": 90, "maxSurfaceAngle": 90}, "rippleEffect": {"show": true, "brushType": "stroke", "scale": 2.5, "period": 4}}], "legend": [{"data": ["采购退货", "取样出库", "调拨出库", "其他出库", "手工出库单", "生产领料出库", "委外出库", "销售出库"], "selected": {}, "show": true, "padding": 5, "itemGap": 10, "itemWidth": 25, "itemHeight": 14, "backgroundColor": "transparent", "borderColor": "#ccc", "borderRadius": 0, "pageButtonItemGap": 5, "pageButtonPosition": "end", "pageFormatter": "{current}/{total}", "pageIconColor": "#2f4554", "pageIconInactiveColor": "#aaa", "pageIconSize": 15, "animationDurationUpdate": 800, "selector": false, "selectorPosition": "auto", "selectorItemGap": 7, "selectorButtonGap": 10}], "tooltip": {"show": true, "trigger": "axis", "triggerOn": "mousemove|click", "axisPointer": {"type": "line"}, "showContent": true, "alwaysShowContent": false, "showDelay": 0, "hideDelay": 100, "enterable": false, "confine": true, "appendToBody": false, "transitionDuration": 0.4, "textStyle": {"fontSize": 14}, "borderWidth": 0, "padding": 5, "order": "seriesAsc"}, "title": [{"show": true, "text": "不同订单类型的数量", "target": "blank", "subtarget": "blank", "padding": 5, "itemGap": 10, "textAlign": "auto", "textVerticalAlign": "auto", "triggerEvent": false}]}'}, 'error_message': None}
2025-09-10 14:56:38.261 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.tool_executor:_execute_tools:171 - Add Tool usage ret: is_success=True message='新增成功' result=None
2025-09-10 14:56:38.261 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.tool_executor:_execute_tools:172 - Successfully scheduled tool usage db write for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34
2025-09-10 14:56:38.261 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:93 - --- ECharts Tool Executor: ECharts工具Dict: {'status': 'success', 'data': {'pie_json_result': '{"animation": true, "animationThreshold": 2000, "animationDuration": 1000, "animationEasing": "cubicOut", "animationDelay": 0, "animationDurationUpdate": 300, "animationEasingUpdate": "cubicOut", "animationDelayUpdate": 0, "aria": {"enabled": false}, "color": ["#5470c6", "#91cc75", "#fac858", "#ee6666", "#73c0de", "#3ba272", "#fc8452", "#9a60b4", "#ea7ccc"], "series": [{"type": "pie", "colorBy": "data", "legendHoverLink": true, "selectedMode": false, "selectedOffset": 10, "clockwise": true, "startAngle": 90, "minAngle": 0, "minShowLabelAngle": 0, "avoidLabelOverlap": true, "stillShowZeroSum": true, "percentPrecision": 2, "showEmptyCircle": true, "emptyCircleStyle": {"color": "lightgray", "borderColor": "#000", "borderWidth": 0, "borderType": "solid", "borderDashOffset": 0, "borderCap": "butt", "borderJoin": "bevel", "borderMiterLimit": 10, "opacity": 1}, "data": [{"name": "采购退货", "value": 77}, {"name": "取样出库", "value": 401}, {"name": "调拨出库", "value": 117}, {"name": "其他出库", "value": 286}, {"name": "手工出库单", "value": 114}, {"name": "生产领料出库", "value": 185}, {"name": "委外出库", "value": 66}, {"name": "销售出库", "value": 165}], "radius": "50%", "center": ["50%", "50%"], "label": {"show": true, "margin": 8, "formatter": "{b}: {c}", "valueAnimation": false}, "labelLine": {"show": true, "showAbove": false, "length": 15, "length2": 15, "smooth": false, "minTurnAngle": 90, "maxSurfaceAngle": 90}, "rippleEffect": {"show": true, "brushType": "stroke", "scale": 2.5, "period": 4}}], "legend": [{"data": ["采购退货", "取样出库", "调拨出库", "其他出库", "手工出库单", "生产领料出库", "委外出库", "销售出库"], "selected": {}, "show": true, "padding": 5, "itemGap": 10, "itemWidth": 25, "itemHeight": 14, "backgroundColor": "transparent", "borderColor": "#ccc", "borderRadius": 0, "pageButtonItemGap": 5, "pageButtonPosition": "end", "pageFormatter": "{current}/{total}", "pageIconColor": "#2f4554", "pageIconInactiveColor": "#aaa", "pageIconSize": 15, "animationDurationUpdate": 800, "selector": false, "selectorPosition": "auto", "selectorItemGap": 7, "selectorButtonGap": 10}], "tooltip": {"show": true, "trigger": "axis", "triggerOn": "mousemove|click", "axisPointer": {"type": "line"}, "showContent": true, "alwaysShowContent": false, "showDelay": 0, "hideDelay": 100, "enterable": false, "confine": true, "appendToBody": false, "transitionDuration": 0.4, "textStyle": {"fontSize": 14}, "borderWidth": 0, "padding": 5, "order": "seriesAsc"}, "title": [{"show": true, "text": "不同订单类型的数量", "target": "blank", "subtarget": "blank", "padding": 5, "itemGap": 10, "textAlign": "auto", "textVerticalAlign": "auto", "triggerEvent": false}]}'}, 'error_message': None} ---
2025-09-10 14:56:38.262 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:101 - --- Leave node: ECharts Tool Executor ---
2025-09-10 14:56:38.263 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-10 14:56:38.263 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-10 14:56:38.264 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-10 14:56:38.266 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-10 14:56:38.280 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 95 ---
2025-09-10 14:56:38.292 | 7d9af06de14640c688076b455e5ae07a | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 96 ---
2025-09-10 14:56:38.293 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-10 14:56:38.390 | 7d9af06de14640c688076b455e5ae07a | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-10 14:56:57.932 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-10 14:56:57.933 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-10 14:56:58.019 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-10 14:56:58.027 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 96 ---
2025-09-10 14:56:58.027 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-10 14:56:58.030 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-10 14:56:59.382 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34, Total Tokens: 4370, Prompt Tokens: 4349, Completion Tokens: 21
2025-09-10 14:56:59.391 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-10 14:56:59.392 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34
2025-09-10 14:56:59.395 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-10 14:56:59.396 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-10 14:56:59.397 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-10 14:56:59.397 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-10 14:56:59.401 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-10 14:56:59.401 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-10 14:56:59.406 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-10 14:56:59.406 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-10 14:56:59.407 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 查询未关闭的入库订单(前10条)
2025-09-10 14:56:59.407 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-10 14:56:59.407 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-10 14:56:59.408 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 440)
2025-09-10 14:56:59.408 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'ZHANGXY', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiOGZjOGQ0YmYtYWYyMC00MzA3LWFjNTEtOGI5N2M1ZjdmZGZhIiwiaWF0IjoxNzU3NDg3Mjk5LCJleHAiOjE3NTc0ODc4OTl9.cQwL-HTB1APk2WyuGXU7aVBK7W9vN9ADpAoGb8AfqQI', 'Signature': 'f52204c2f49b8b07fef1d1a16377711b', 'Message': '%E6%9F%A5%E8%AF%A2%E6%9C%AA%E5%85%B3%E9%97%AD%E7%9A%84%E5%85%A5%E5%BA%93%E8%AE%A2%E5%8D%95%28%E5%89%8D10%E6%9D%A1%29'}
2025-09-10 14:57:06.816 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-10 14:57:06.893 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 10 (<= 1000), 执行全量查询.
2025-09-10 14:57:06.907 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/056d2ffa-f03b-47e4-8f95-28419ba5f4e6.xlsx
2025-09-10 14:57:06.922 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/056d2ffa-f03b-47e4-8f95-28419ba5f4e6.xlsx
2025-09-10 14:57:06.923 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-10 14:57:06.923 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-10 14:57:06.925 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-10 14:57:06.925 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-10 14:57:06.927 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-10 14:57:06.927 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-10 14:57:06.927 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-10 14:57:06.928 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-10 14:57:07.764 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34, Total Tokens: 941, Prompt Tokens: 923, Completion Tokens: 18
2025-09-10 14:57:07.771 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-10 14:57:07.772 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: eea1aaea-f836-4520-be5b-ff9132428c34
2025-09-10 14:57:07.773 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{\n  "asnNo": "预期到货通知编号"\n}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 18, 'prompt_tokens': 923, 'total_tokens': 941, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-861c2ce4-94c2-41ef-9c49-81b1bb41a33a', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--9ed151d6-39e2-4dca-96f9-974d744e6bfd-0' usage_metadata={'input_tokens': 923, 'output_tokens': 18, 'total_tokens': 941, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-10 14:57:07.775 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {'asnNo': '预期到货通知编号'}
2025-09-10 14:57:07.776 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共10行）:
| 预期到货通知编号 | 订单状态 | 订单类型 | 供应商名称 | 预期数量 |
|---|---|---|---|---|
| [A2212220001](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMjEyMjIwMDAxIn19fQ==) | 部分收货 |  |  | 9600 |
| [A2212260002](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMjEyMjYwMDAyIn19fQ==) | 订单创建 |  |  | 150 |
| [A2212300001](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMjEyMzAwMDAxIn19fQ==) | 订单创建 |  |  | 50 |
| [A2301050001](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDUwMDAxIn19fQ==) | 订单创建 |  |  | 7 |
| [A2301050002](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDUwMDAyIn19fQ==) | 订单创建 |  |  | 7 |
| [A2301060001](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDYwMDAxIn19fQ==) | 订单创建 |  |  | 12000 |
| [A2301060002](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDYwMDAyIn19fQ==) | 部分收货 |  |  | 144000 |
| [A2301060004](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDYwMDA0In19fQ==) | 订单创建 |  |  | 0.01% |
| [A2301060005](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDYwMDA1In19fQ==) | 订单创建 | 采购入库 |  | 101 |
| [A2301090001](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDkwMDAxIn19fQ==) | 订单创建 |  |  | 6000 |
2025-09-10 14:57:07.776 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 预期到货通知编号 | 订单状态 | 订单类型 | 供应商名称 | 预期数量 |
|---|---|---|---|---|
| [A2212220001](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMjEyMjIwMDAxIn19fQ==) | 部分收货 |  |  | 9600 |
| [A2212260002](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMjEyMjYwMDAyIn19fQ==) | 订单创建 |  |  | 150 |
| [A2212300001](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMjEyMzAwMDAxIn19fQ==) | 订单创建 |  |  | 50 |
| [A2301050001](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDUwMDAxIn19fQ==) | 订单创建 |  |  | 7 |
| [A2301050002](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDUwMDAyIn19fQ==) | 订单创建 |  |  | 7 |
| [A2301060001](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDYwMDAxIn19fQ==) | 订单创建 |  |  | 12000 |
| [A2301060002](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDYwMDAyIn19fQ==) | 部分收货 |  |  | 144000 |
| [A2301060004](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDYwMDA0In19fQ==) | 订单创建 |  |  | 0.01% |
| [A2301060005](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDYwMDA1In19fQ==) | 订单创建 | 采购入库 |  | 101 |
| [A2301090001](#eyJpZCI6ICJBMjAwMiIsICJpbnB1dCI6IHsicXVlcnkiOiB7ImFzbk5vIjogIkEyMzAxMDkwMDAxIn19fQ==) | 订单创建 |  |  | 6000 | ---
2025-09-10 14:57:07.776 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-10 14:57:07.778 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-10 14:57:07.780 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-10 14:57:07.781 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-10 14:57:07.781 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-10 14:57:07.785 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-10 14:57:07.796 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 97 ---
2025-09-10 14:57:07.805 | c4967e7e0b8549fa80272fd6b36de645 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 98 ---
2025-09-10 14:57:07.806 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-10 14:57:07.894 | c4967e7e0b8549fa80272fd6b36de645 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 09:48:54.598 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 09:48:54.600 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 09:48:54.657 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 09:48:54.689 | 25fc9eba035c44caae3470a76162b30c | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 09:48:54.689 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 09:48:54.691 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 09:48:54.692 | 25fc9eba035c44caae3470a76162b30c | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:28 - --- Main Agent: 用户自定义意图: DOC_QUERY ---
2025-09-11 09:48:54.693 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 09:48:54.694 | 25fc9eba035c44caae3470a76162b30c | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go doc query ---
2025-09-11 09:48:54.697 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.graph.node.doc_query:doc_query_node:19 - --- Enter node: Doc Query ---
2025-09-11 09:48:54.697 | 25fc9eba035c44caae3470a76162b30c | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 09:48:54.697 | 25fc9eba035c44caae3470a76162b30c | DEBUG    | apps.module_business.service.luma_service:get_doc_content_from_luma:62 - Getting documents content from Luma with message: 介绍一下WMS的分配逻辑
2025-09-11 09:48:54.698 | 25fc9eba035c44caae3470a76162b30c | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 09:48:54.698 | 25fc9eba035c44caae3470a76162b30c | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 401)
2025-09-11 09:48:54.698 | 25fc9eba035c44caae3470a76162b30c | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/chat, headers: {'organizationId': 'HHYY', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiZTljMTAxZGYtYmYyMi00YWJjLWFiNWUtOGM2MmUxNjIwMTFjIiwiaWF0IjoxNzU3NTU1MjE0LCJleHAiOjE3NTc1NTU4MTR9.jKN-PTNts4ntADIPvJVY9E8Y3k4wkh00S3N1iONXL2w', 'Signature': '7bc9dc65720ae5474951b390efe898d1', 'Message': '%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8BWMS%E7%9A%84%E5%88%86%E9%85%8D%E9%80%BB%E8%BE%91'}
2025-09-11 09:49:08.534 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/chat
2025-09-11 09:49:08.535 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.graph.node.doc_query:doc_query_node:37 - --- Leave node: Doc Query ---
2025-09-11 09:49:08.538 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 09:49:08.559 | 25fc9eba035c44caae3470a76162b30c | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 99 ---
2025-09-11 09:49:08.569 | 25fc9eba035c44caae3470a76162b30c | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 100 ---
2025-09-11 09:49:08.569 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 09:49:08.655 | 25fc9eba035c44caae3470a76162b30c | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 09:51:50.449 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 09:51:50.449 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 09:51:50.530 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 09:51:50.537 | 4a80d0e89b7440548c32bb359bddaab8 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 100 ---
2025-09-11 09:51:50.537 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 09:51:50.539 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 09:51:50.540 | 4a80d0e89b7440548c32bb359bddaab8 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:28 - --- Main Agent: 用户自定义意图: DOC_QUERY ---
2025-09-11 09:51:50.540 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 09:51:50.541 | 4a80d0e89b7440548c32bb359bddaab8 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go doc query ---
2025-09-11 09:51:50.543 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.graph.node.doc_query:doc_query_node:19 - --- Enter node: Doc Query ---
2025-09-11 09:51:50.543 | 4a80d0e89b7440548c32bb359bddaab8 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 09:51:50.544 | 4a80d0e89b7440548c32bb359bddaab8 | DEBUG    | apps.module_business.service.luma_service:get_doc_content_from_luma:62 - Getting documents content from Luma with message: 请介绍一下上架规则
2025-09-11 09:51:50.544 | 4a80d0e89b7440548c32bb359bddaab8 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 09:51:50.545 | 4a80d0e89b7440548c32bb359bddaab8 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 398)
2025-09-11 09:51:50.545 | 4a80d0e89b7440548c32bb359bddaab8 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/chat, headers: {'organizationId': 'HHYY', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiZTY1YjllNGQtZDBhOC00YzBkLTk4OWEtNTkwZDJkYTA3OGE3IiwiaWF0IjoxNzU3NTU1MzkwLCJleHAiOjE3NTc1NTU5OTB9.XieRdOLIDy8cpU7cNzNfDwGZ34ErrLQyWJxGofa1dR0', 'Signature': '7349d81a45c86981c6d85bc9f9342690', 'Message': '%E8%AF%B7%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8B%E4%B8%8A%E6%9E%B6%E8%A7%84%E5%88%99'}
2025-09-11 09:52:02.242 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/chat
2025-09-11 09:52:02.243 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.graph.node.doc_query:doc_query_node:37 - --- Leave node: Doc Query ---
2025-09-11 09:52:02.246 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 09:52:02.259 | 4a80d0e89b7440548c32bb359bddaab8 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 101 ---
2025-09-11 09:52:02.271 | 4a80d0e89b7440548c32bb359bddaab8 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 102 ---
2025-09-11 09:52:02.271 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 09:52:02.364 | 4a80d0e89b7440548c32bb359bddaab8 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 09:59:29.664 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 09:59:29.665 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 09:59:29.766 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 09:59:29.775 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 102 ---
2025-09-11 09:59:29.776 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 09:59:29.777 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 09:59:30.581 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 8ad65ee5-9c84-4143-988f-adf6b75f7294, Total Tokens: 1037, Prompt Tokens: 1016, Completion Tokens: 21
2025-09-11 09:59:30.595 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 09:59:30.596 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 8ad65ee5-9c84-4143-988f-adf6b75f7294
2025-09-11 09:59:30.598 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 09:59:30.598 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 09:59:30.599 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 09:59:30.600 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 09:59:30.603 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 09:59:30.603 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 09:59:30.668 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 09:59:30.668 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 09:59:30.669 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 查询近一周的发运订单
2025-09-11 09:59:30.670 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 09:59:30.672 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 09:59:30.673 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 414)
2025-09-11 09:59:30.674 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'ZHANGXY', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiYjI1ZTVhYTEtZTQyOC00YWUwLTk1ZWQtNDVhMWVhOGNiZDFlIiwiaWF0IjoxNzU3NTU1ODUwLCJleHAiOjE3NTc1NTY0NTB9.RWJ9ZMMU2xIHuhKgqV3AyHlXUQyJLImD7NVdlT7Z4gc', 'Signature': '4ced9f8a8c18bc91db02a83e82998b5b', 'Message': '%E6%9F%A5%E8%AF%A2%E8%BF%91%E4%B8%80%E5%91%A8%E7%9A%84%E5%8F%91%E8%BF%90%E8%AE%A2%E5%8D%95'}
2025-09-11 09:59:39.212 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 09:59:39.260 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 3 (<= 1000), 执行全量查询.
2025-09-11 09:59:39.289 | be667f71407f4a23936b68244c042eaa | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/9b863d0c-9eda-4963-ad09-d0e87264562e.xlsx
2025-09-11 09:59:39.303 | be667f71407f4a23936b68244c042eaa | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/9b863d0c-9eda-4963-ad09-d0e87264562e.xlsx
2025-09-11 09:59:39.305 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 09:59:39.305 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 09:59:39.307 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 09:59:39.308 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 09:59:39.310 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 09:59:39.310 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 09:59:39.311 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 09:59:39.311 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 09:59:40.485 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 8ad65ee5-9c84-4143-988f-adf6b75f7294, Total Tokens: 954, Prompt Tokens: 939, Completion Tokens: 15
2025-09-11 09:59:40.492 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 09:59:40.493 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 8ad65ee5-9c84-4143-988f-adf6b75f7294
2025-09-11 09:59:40.493 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{\n  "orderNo": "订单号"\n}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 15, 'prompt_tokens': 939, 'total_tokens': 954, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-dd09e16b-62b5-438a-befe-d5d1e97e9cfc', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--a87a9b8c-93b2-45b5-a8fa-3672b30fcc2b-0' usage_metadata={'input_tokens': 939, 'output_tokens': 15, 'total_tokens': 954, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 09:59:40.494 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {'orderNo': '订单号'}
2025-09-11 09:59:40.494 | be667f71407f4a23936b68244c042eaa | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共3行）:
| 订单号 | 订单类型 | 订单状态 | 收货人名称 | 收货地址 | 订单数量 |
|---|---|---|---|---|---|
| [S2509090002](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAiUzI1MDkwOTAwMDIifX19) | 其他出库 | 非正常关闭 |  |  | 2 |
| [S2509100001](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAiUzI1MDkxMDAwMDEifX19) | 其他出库 | 创建订单 |  |  | 2 |
| [S2509090001](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAiUzI1MDkwOTAwMDEifX19) | 手工出库单 | 创建订单 | HHYY |  | 504 |
2025-09-11 09:59:40.495 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 订单号 | 订单类型 | 订单状态 | 收货人名称 | 收货地址 | 订单数量 |
|---|---|---|---|---|---|
| [S2509090002](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAiUzI1MDkwOTAwMDIifX19) | 其他出库 | 非正常关闭 |  |  | 2 |
| [S2509100001](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAiUzI1MDkxMDAwMDEifX19) | 其他出库 | 创建订单 |  |  | 2 |
| [S2509090001](#eyJpZCI6ICJBMzAwMSIsICJpbnB1dCI6IHsicXVlcnkiOiB7Im9yZGVyTm8iOiAiUzI1MDkwOTAwMDEifX19) | 手工出库单 | 创建订单 | HHYY |  | 504 | ---
2025-09-11 09:59:40.495 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 09:59:40.497 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 09:59:40.499 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 09:59:40.499 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 09:59:40.499 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 09:59:40.501 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 09:59:40.511 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 103 ---
2025-09-11 09:59:40.520 | be667f71407f4a23936b68244c042eaa | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 104 ---
2025-09-11 09:59:40.521 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 09:59:40.616 | be667f71407f4a23936b68244c042eaa | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 13:36:35.579 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 13:36:35.581 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 13:36:35.625 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 13:36:35.651 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 13:36:35.651 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 13:36:35.652 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 13:36:36.625 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 9008c960-7d99-471d-b221-4b42bdba2545, Total Tokens: 830, Prompt Tokens: 809, Completion Tokens: 21
2025-09-11 13:36:36.633 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:36:36.633 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 9008c960-7d99-471d-b221-4b42bdba2545
2025-09-11 13:36:36.634 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 13:36:36.635 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 13:36:36.635 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 13:36:36.636 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 13:36:36.639 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 13:36:36.639 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 13:39:35.547 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 13:39:35.547 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 13:39:35.604 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 13:39:35.629 | 3681145b1b0343d19d87cbd7e56e33c3 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 13:39:35.630 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 13:39:35.632 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 13:39:36.790 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 828, Prompt Tokens: 807, Completion Tokens: 21
2025-09-11 13:39:36.803 | 3681145b1b0343d19d87cbd7e56e33c3 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:39:36.803 | 3681145b1b0343d19d87cbd7e56e33c3 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 13:39:36.805 | 3681145b1b0343d19d87cbd7e56e33c3 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 13:39:36.805 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 13:39:36.806 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 13:39:36.807 | 3681145b1b0343d19d87cbd7e56e33c3 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 13:39:36.809 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 13:39:36.809 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 13:39:36.868 | 3681145b1b0343d19d87cbd7e56e33c3 | ERROR    | apps.module_business.service.business_service:search_user_permission:67 - search_user_permission error: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'user_id'
[SQL: select h1.customerId
                                      from BSM_USER_OWNER h1
                                      where 1 = 1
                                        and h1.organizationId = :organization_id
                                        and h1.userId = :user_id
                                        AND (h1.subSystem IN ('WMS', 'SEC', 'BMS', 'RF', 'WRF6') OR
                                             h1.subSystem = 'YMS')
                                   ]
[parameters: [{'organization_id': 'HHYY', 'userId': None}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
2025-09-11 13:39:36.868 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:53 - --- Leave node: Data Query ---
2025-09-11 13:39:36.869 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 13:39:36.870 | 3681145b1b0343d19d87cbd7e56e33c3 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 13:39:36.872 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 13:39:36.873 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 13:39:36.873 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:288 - --- Leave node: Combine Data ---
2025-09-11 13:39:36.877 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 13:39:36.895 | 3681145b1b0343d19d87cbd7e56e33c3 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 105 ---
2025-09-11 13:39:36.905 | 3681145b1b0343d19d87cbd7e56e33c3 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 106 ---
2025-09-11 13:39:36.905 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 13:39:37.007 | 3681145b1b0343d19d87cbd7e56e33c3 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 13:41:24.113 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 13:41:24.113 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 13:41:24.161 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 13:41:24.176 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 13:41:24.176 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 13:41:24.178 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 13:41:25.250 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 3aeb61c2-abcb-4efb-a1cd-b04a89c3aab8, Total Tokens: 827, Prompt Tokens: 806, Completion Tokens: 21
2025-09-11 13:41:25.258 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:41:25.258 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 3aeb61c2-abcb-4efb-a1cd-b04a89c3aab8
2025-09-11 13:41:25.259 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 13:41:25.260 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 13:41:25.261 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 13:41:25.261 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 13:41:25.263 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 13:41:25.264 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 13:41:51.491 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 13:41:51.492 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 13:41:51.587 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 13:41:51.593 | 96a62b878a044ff5864c5b550e8843b9 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 106 ---
2025-09-11 13:41:51.593 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 13:41:51.595 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 13:41:52.321 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 933, Prompt Tokens: 912, Completion Tokens: 21
2025-09-11 13:41:52.328 | 96a62b878a044ff5864c5b550e8843b9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:41:52.329 | 96a62b878a044ff5864c5b550e8843b9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 13:41:52.330 | 96a62b878a044ff5864c5b550e8843b9 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 13:41:52.331 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 13:41:52.332 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 13:41:52.333 | 96a62b878a044ff5864c5b550e8843b9 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 13:41:52.336 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 13:41:52.336 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 13:41:52.341 | 96a62b878a044ff5864c5b550e8843b9 | ERROR    | apps.module_business.service.business_service:search_user_permission:67 - search_user_permission error: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter 'user_id'
[SQL: select h1.customerId
                                      from BSM_USER_OWNER h1
                                      where 1 = 1
                                        and h1.organizationId = :organization_id
                                        and h1.userId = :user_id
                                        AND (h1.subSystem IN ('WMS', 'SEC', 'BMS', 'RF', 'WRF6') OR
                                             h1.subSystem = 'YMS')
                                   ]
[parameters: [{'organization_id': 'HHYY', 'userId': None}]]
(Background on this error at: https://sqlalche.me/e/20/cd3x)
2025-09-11 13:41:52.342 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:53 - --- Leave node: Data Query ---
2025-09-11 13:41:52.342 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 13:41:52.343 | 96a62b878a044ff5864c5b550e8843b9 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 13:41:52.344 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 13:41:52.345 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 13:41:52.345 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:288 - --- Leave node: Combine Data ---
2025-09-11 13:41:52.346 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 13:41:52.356 | 96a62b878a044ff5864c5b550e8843b9 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 107 ---
2025-09-11 13:41:52.364 | 96a62b878a044ff5864c5b550e8843b9 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 108 ---
2025-09-11 13:41:52.364 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 13:41:52.459 | 96a62b878a044ff5864c5b550e8843b9 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 13:44:01.702 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 13:44:01.702 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 13:44:01.807 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 13:44:01.819 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 108 ---
2025-09-11 13:44:01.819 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 13:44:01.821 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 13:44:02.721 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 1039, Prompt Tokens: 1018, Completion Tokens: 21
2025-09-11 13:44:02.731 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:44:02.732 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 13:44:02.733 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 13:44:02.734 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 13:44:02.735 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 13:44:02.735 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 13:44:02.737 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 13:44:02.738 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 13:44:23.479 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 13:44:23.479 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 13:44:23.522 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 13:44:23.534 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 13:44:23.534 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 13:44:23.536 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 13:44:24.257 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 65b1893b-8c35-4496-86a9-c42e131c77f9, Total Tokens: 831, Prompt Tokens: 810, Completion Tokens: 21
2025-09-11 13:44:24.269 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:44:24.270 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 65b1893b-8c35-4496-86a9-c42e131c77f9
2025-09-11 13:44:24.272 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 13:44:24.272 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 13:44:24.273 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 13:44:24.273 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 13:44:24.275 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 13:44:24.275 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 13:44:24.301 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 13:44:24.302 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 13:44:24.302 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 现在一共有多少蟾酥在仓库里？
2025-09-11 13:44:24.302 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 13:44:24.303 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 13:44:24.303 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 449)
2025-09-11 13:44:24.303 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': '901846', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiZGM4NmQxOWYtYzkwOS00ZWM5LWJmODctYWQ4MDFiNTVlNzZkIiwiaWF0IjoxNzU3NTY5MzQ0LCJleHAiOjE3NTc1Njk5NDR9.rviTYbJW2o9oBwKtWLg6UtZJ174hFJ18gRpgMI-Srqs', 'Signature': 'cf2defb0551c7a5e9f7bc09165c6ec8c', 'Message': '%E7%8E%B0%E5%9C%A8%E4%B8%80%E5%85%B1%E6%9C%89%E5%A4%9A%E5%B0%91%E8%9F%BE%E9%85%A5%E5%9C%A8%E4%BB%93%E5%BA%93%E9%87%8C%EF%BC%9F'}
2025-09-11 13:44:31.140 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 13:44:31.167 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_business.service.business_service:search_data_from_sql:125 - 数据量为 2126 (> 1000), 执行流式查询.
2025-09-11 13:44:31.759 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | utils.excel_util:generate_excel_file_using_stream:203 - 成功生成Excel文件: /app/excel_file/ce9c7fa5-0855-4028-a6ef-a52aec1dd634.xlsx
2025-09-11 13:44:31.760 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 13:44:31.761 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 13:44:31.763 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 13:44:31.763 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 13:44:31.765 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 13:44:31.765 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 13:44:31.765 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 13:44:31.766 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 13:44:32.479 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 65b1893b-8c35-4496-86a9-c42e131c77f9, Total Tokens: 999, Prompt Tokens: 994, Completion Tokens: 5
2025-09-11 13:44:32.489 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:44:32.490 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 65b1893b-8c35-4496-86a9-c42e131c77f9
2025-09-11 13:44:32.492 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 994, 'total_tokens': 999, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-a3e8a1f5-3f3e-4d77-b533-666b8bdeb61d', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--89e00f62-5489-4908-88d0-88d03c927a5a-0' usage_metadata={'input_tokens': 994, 'output_tokens': 5, 'total_tokens': 999, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 13:44:32.493 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 13:44:32.493 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 13:44:32.494 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 22 | 22 | T0007 | LT00001981 | * | HHYY | 1011000111 | 麝香保心丸,42丸/盒,300盒/箱,每丸重22.5mg |  |  |  | SHPL_待验 |
| WH01 | 10 | 10 | 17-00-002 | LT00079517 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2024-12-04 |  | SHPL_待验 |
| WH01 | 0 | 0 | TEST022 | LT00001134 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 |  | SHPL_待验 |
| WH01 | 100 | 0 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 |
| WH01 | 10 | 10 | 17-00-002 | LT00003416 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2025-02-20 |  |  |
| WH01 | 0 | 287000 | 17-00-001 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 |
| WH01 | 0 | 0 | 01 | LT00002000 | 05-16-01 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  |
| WH01 | 10 | 10 | 17-00-002 | LT00003338 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2024-11-22 |  |  |
| WH01 | 100 | 100 | 03-02-038 | LT00002178 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00066 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00065 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00081 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 4000 | 4000 | 01002006 | LT00000167 | BCR00051-ZK2 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-03-21 | SHPL_待验 |
| WH01 | 6000 | 0 | 01004004 | LT00000151 | BCR00080 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 9900 | 9900 | 001 | LT00000494 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2020-03-03 | 2023-02-28 | 2023-02-27 | SHPL_合格 |
| WH01 | 0 | 6000 | 01005005 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 20 | 0 | 001 | LT00000147 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-04-13 | 2024-05-31 | 2023-03-02 | 有效 |
| WH01 | 6000 | 0 | 01003006 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 6000 | 0 | 01010001 | LT00000227 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09 | SHPL_合格 |
| WH01 | 0 | 6000 | 01030006 | LT00000226 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09 | SHPL_合格 |
2025-09-11 13:44:32.494 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 22 | 22 | T0007 | LT00001981 | * | HHYY | 1011000111 | 麝香保心丸,42丸/盒,300盒/箱,每丸重22.5mg |  |  |  | SHPL_待验 |
| WH01 | 10 | 10 | 17-00-002 | LT00079517 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2024-12-04 |  | SHPL_待验 |
| WH01 | 0 | 0 | TEST022 | LT00001134 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 |  | SHPL_待验 |
| WH01 | 100 | 0 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 |
| WH01 | 10 | 10 | 17-00-002 | LT00003416 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2025-02-20 |  |  |
| WH01 | 0 | 287000 | 17-00-001 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 |
| WH01 | 0 | 0 | 01 | LT00002000 | 05-16-01 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  |
| WH01 | 10 | 10 | 17-00-002 | LT00003338 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2024-11-22 |  |  |
| WH01 | 100 | 100 | 03-02-038 | LT00002178 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00066 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00065 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00081 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 4000 | 4000 | 01002006 | LT00000167 | BCR00051-ZK2 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-03-21 | SHPL_待验 |
| WH01 | 6000 | 0 | 01004004 | LT00000151 | BCR00080 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 9900 | 9900 | 001 | LT00000494 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2020-03-03 | 2023-02-28 | 2023-02-27 | SHPL_合格 |
| WH01 | 0 | 6000 | 01005005 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 20 | 0 | 001 | LT00000147 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-04-13 | 2024-05-31 | 2023-03-02 | 有效 |
| WH01 | 6000 | 0 | 01003006 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 |
| WH01 | 6000 | 0 | 01010001 | LT00000227 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09 | SHPL_合格 |
| WH01 | 0 | 6000 | 01030006 | LT00000226 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09 | SHPL_合格 | ---
2025-09-11 13:44:32.496 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 13:44:32.500 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 13:44:32.501 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 13:44:32.502 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 13:44:32.502 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 13:44:32.504 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 13:44:32.517 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 109 ---
2025-09-11 13:44:32.532 | 5548e86798bc475c9b6f2ce5adc0a33b | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 110 ---
2025-09-11 13:44:32.532 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 13:44:32.627 | 5548e86798bc475c9b6f2ce5adc0a33b | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 13:47:09.222 | 64dcc7fb83f844eab9fc2d485437fbd2 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ('data_query',)
2025-09-11 13:47:09.223 | 64dcc7fb83f844eab9fc2d485437fbd2 | DEBUG    | apps.module_llm.chat.chat_controller:do_chat:105 - --- Conversation is paused, current input: 1011000112有多少库存 ---
2025-09-11 13:47:09.223 | 64dcc7fb83f844eab9fc2d485437fbd2 | DEBUG    | apps.module_llm.chat.chat_controller:do_chat:112 - --- User rejected/modified. Resuming with feedback ToolMessage ---
2025-09-11 13:47:16.146 | 4888077b5be04399b501d881833655f4 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ('data_query',)
2025-09-11 13:47:16.147 | 4888077b5be04399b501d881833655f4 | DEBUG    | apps.module_llm.chat.chat_controller:do_chat:105 - --- Conversation is paused, current input: 1011000112有多少库存
 ---
2025-09-11 13:47:16.147 | 4888077b5be04399b501d881833655f4 | DEBUG    | apps.module_llm.chat.chat_controller:do_chat:112 - --- User rejected/modified. Resuming with feedback ToolMessage ---
2025-09-11 13:52:09.020 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 13:52:09.020 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 13:52:09.021 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 这两天的入库情况
2025-09-11 13:52:09.021 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 13:52:09.022 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 13:52:09.022 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 392)
2025-09-11 13:52:09.023 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiOWU2ZWI2OTctZjE0My00MjdjLWFmZWMtYTA1YThkMThiNjdkIiwiaWF0IjoxNzU3NTY5ODA5LCJleHAiOjE3NTc1NzA0MDl9.SmYEiYRXyO9hfCPgdrjChsdrtHhJoD2C4rm9nEzx9iI', 'Signature': '71ba756a896c7588fa0de779f1dedf23', 'Message': '%E8%BF%99%E4%B8%A4%E5%A4%A9%E7%9A%84%E5%85%A5%E5%BA%93%E6%83%85%E5%86%B5'}
2025-09-11 13:52:18.201 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 13:52:18.207 | 0ee13498d5114bf2b8dc9a393be88cac | ERROR    | apps.module_business.service.business_service:search_data_from_sql:154 - 执行sql出错: (oracledb.exceptions.DatabaseError) ORA-00907: missing right parenthesis
Help: https://docs.oracle.com/error-help/db/ora-00907/
[SQL: SELECT COUNT(*) count FROM ( SELECT      DAH.asnNo AS 预期到货通知编号,     BSM1.codeDescr AS 订单状态,     BSM2.codeDescr AS 订单类型,     DAH.supplierName AS 供应商名称,     SUM(DAD.expectedQty_Each) AS 预期数量 FROM      DOC_ASN_HEADER DAH LEFT JOIN      DOC_ASN_DETAILS DAD ON DAH.organizationId = DAD.organizationId     AND DAH.warehouseId = DAD.warehouseId     AND DAH.asnNo = DAD.asnNo LEFT JOIN      BSM_CODE_ML BSM1 ON      DAH.asnStatus = BSM1.codeId     AND BSM1.codeType = 'ASN_STS'     AND DAH.organizationId = BSM1.organizationId     AND BSM1.languageId = 'zh_CN' LEFT JOIN      BSM_CODE_ML BSM2 ON      DAH.asnType = BSM2.codeId AND      BSM2.codeType = 'ASN_TYP' AND      DAH.organizationId = BSM2.organizationId AND      BSM2.languageId = 'zh_CN' WHERE      DAH.warehouseId = 'WH01' AND      DAH.organizationId = 'HHYY' AND      DAH.asnCreationTime >= TRUNC(SYSDATE) - 1 AND      DAH.asnCreationTime < TRUNC(SYSDATE) + 1 GROUP BY      DAH.asnNo,      BSM1.codeDescr,      BSM2.codeDescr,      DAH.supplierName   在这个SQL查询中，我们从`DOC_ASN_HEADER`和`DOC_ASN_DETAILS`表中查询了最近两天的入库情况。我们使用了`LEFT JOIN`来连接`DOC_ASN_HEADER`和`DOC_ASN_DETAILS`表，并根据`organizationId`、`warehouseId`和`asnNo`进行连接。我们还将`asnType`和`asnStatus`字段与`BSM_CODE_ML`表连接，以获取其对应的描述。查询条件中增加了仓库条件`warehouseId='WH01'`和组织编码为`HHYY`，并限制查询时间为最近两天。最后，我们对结果按`asnNo`和`asnType`进行分组，并计算`expectedQty_Each`的总和。) t]
(Background on this error at: https://sqlalche.me/e/20/4xp6)
2025-09-11 13:52:18.208 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:118 - --- Leave node: Data Query ---
2025-09-11 13:52:18.212 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 13:52:18.212 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 13:52:18.214 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 13:52:18.215 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 13:52:18.215 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:306 - --- Leave node: Combine Data ---
2025-09-11 13:52:18.218 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 13:52:18.229 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 111 ---
2025-09-11 13:52:18.239 | 0ee13498d5114bf2b8dc9a393be88cac | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 112 ---
2025-09-11 13:52:18.239 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 13:52:18.343 | 0ee13498d5114bf2b8dc9a393be88cac | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 13:53:48.678 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 13:53:48.678 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 13:53:48.732 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 13:53:48.743 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 13:53:48.743 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 13:53:48.745 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 13:53:49.441 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: ac900598-0e51-48f6-8771-535372cadad0, Total Tokens: 836, Prompt Tokens: 815, Completion Tokens: 21
2025-09-11 13:53:49.448 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:53:49.448 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: ac900598-0e51-48f6-8771-535372cadad0
2025-09-11 13:53:49.450 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 13:53:49.450 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 13:53:49.451 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 13:53:49.451 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 13:53:49.453 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 13:53:49.453 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 13:53:49.458 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 13:53:49.458 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 13:53:49.459 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 产品1011000112有多少库存
2025-09-11 13:53:49.459 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 13:53:49.460 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 13:53:49.460 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 397)
2025-09-11 13:53:49.460 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'ZHANGXY', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiN2Y4MTczM2EtNTRiMS00NzUxLWI3NmQtMWM0OTA4MjVhZWZkIiwiaWF0IjoxNzU3NTY5OTA5LCJleHAiOjE3NTc1NzA1MDl9.t3OvNjE56ro7mnEK4FWiUFIqgMB7eknZVHwxEyrYDrc', 'Signature': '2db76e8e0e6b67c6646a8a305abe676b', 'Message': '%E4%BA%A7%E5%93%811011000112%E6%9C%89%E5%A4%9A%E5%B0%91%E5%BA%93%E5%AD%98'}
2025-09-11 13:53:55.449 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 13:53:55.462 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 58 (<= 1000), 执行全量查询.
2025-09-11 13:53:55.478 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/166941fa-0719-4500-9acb-a93fd72d9211.xlsx
2025-09-11 13:53:55.503 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/166941fa-0719-4500-9acb-a93fd72d9211.xlsx
2025-09-11 13:53:55.504 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 13:53:55.504 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 13:53:55.506 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 13:53:55.506 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 13:53:55.509 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 13:53:55.509 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 13:53:55.510 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 13:53:55.510 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 13:53:56.329 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: ac900598-0e51-48f6-8771-535372cadad0, Total Tokens: 1019, Prompt Tokens: 1014, Completion Tokens: 5
2025-09-11 13:53:56.338 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:53:56.338 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: ac900598-0e51-48f6-8771-535372cadad0
2025-09-11 13:53:56.339 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 1014, 'total_tokens': 1019, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-0c0a6b78-c7d3-48d1-8c93-1cfa00cc6394', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--de914e30-553d-448b-918a-31a08f2ee637-0' usage_metadata={'input_tokens': 1014, 'output_tokens': 5, 'total_tokens': 1019, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 13:53:56.340 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 13:53:56.340 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 13:53:56.340 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 02 | LT00000045 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 83 | 0 |
| WH01 | 001 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 9954 | 0 |
| WH01 | DYNAMIC_AP_WH01 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 0 | 9954 |
| WH01 | TEST022 | LT00001136 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 0 | 0 |
| WH01 | 01 | LT00002103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00003339 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2025-03-02 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079534 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2024-09-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 17-00-002 | LT00079513 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-06 |  | SHPL_待验 | 10 | 10 |
| WH01 | SORTATION_WH01 | LT00000121 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-02-28 | 2026-02-12 | 2023-02-28 | SHPL_待验 | 11 | 0 |
| WH01 | 001 | LT00000046 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 1101 | 1101 |
| WH01 | 17-00-002 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 917 | 917 |
| WH01 | 07-001-003 | LT00002001 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00002542 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-20 | 2026-08-21 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079518 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 | 19764 | 0 |
| WH01 | BHG004 | LT00000234 | ZK0512 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  | 2023-05-12 | SHPL_待验 | 800 | 799 |
| WH01 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 1 | 0 |
| WH01 | 01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 100 | 0 |
2025-09-11 13:53:56.341 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 02 | LT00000045 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 83 | 0 |
| WH01 | 001 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 9954 | 0 |
| WH01 | DYNAMIC_AP_WH01 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 0 | 9954 |
| WH01 | TEST022 | LT00001136 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 0 | 0 |
| WH01 | 01 | LT00002103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00003339 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2025-03-02 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079534 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2024-09-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 17-00-002 | LT00079513 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-06 |  | SHPL_待验 | 10 | 10 |
| WH01 | SORTATION_WH01 | LT00000121 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-02-28 | 2026-02-12 | 2023-02-28 | SHPL_待验 | 11 | 0 |
| WH01 | 001 | LT00000046 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 1101 | 1101 |
| WH01 | 17-00-002 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 917 | 917 |
| WH01 | 07-001-003 | LT00002001 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00002542 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-20 | 2026-08-21 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079518 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 | 19764 | 0 |
| WH01 | BHG004 | LT00000234 | ZK0512 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  | 2023-05-12 | SHPL_待验 | 800 | 799 |
| WH01 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 1 | 0 |
| WH01 | 01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 100 | 0 | ---
2025-09-11 13:53:56.341 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 13:53:56.343 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 13:53:56.344 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 13:53:56.344 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 13:53:56.344 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 13:53:56.346 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 13:53:56.362 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 113 ---
2025-09-11 13:53:56.376 | e0a4a6d1978a4320ad23a11e5e69a1b7 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 114 ---
2025-09-11 13:53:56.377 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 13:53:56.459 | e0a4a6d1978a4320ad23a11e5e69a1b7 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 13:56:56.768 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 13:56:56.768 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 13:56:56.770 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 现在有多少蟾酥？
2025-09-11 13:56:56.770 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 13:56:56.771 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 13:56:56.771 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 395)
2025-09-11 13:56:56.772 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': '901846', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiNThiODIzMGUtNzYzZi00ZGYzLWJhNGYtMzYzOWViMDc5ZGY2IiwiaWF0IjoxNzU3NTcwMDk2LCJleHAiOjE3NTc1NzA2OTZ9.xLVigx9RK5b2BcDn9Ll2X9mOvMpAuRbH7x-BgfqUqUc', 'Signature': '81b78b95affe5bebdf533da8d3c151a6', 'Message': '%E7%8E%B0%E5%9C%A8%E6%9C%89%E5%A4%9A%E5%B0%91%E8%9F%BE%E9%85%A5%EF%BC%9F'}
2025-09-11 13:57:03.577 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 13:57:03.602 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_business.service.business_service:search_data_from_sql:125 - 数据量为 2126 (> 1000), 执行流式查询.
2025-09-11 13:57:04.221 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | utils.excel_util:generate_excel_file_using_stream:203 - 成功生成Excel文件: /app/excel_file/912d447d-4a4e-46db-906e-c5b75bd8f695.xlsx
2025-09-11 13:57:04.222 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 13:57:04.223 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 13:57:04.228 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 13:57:04.229 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 13:57:04.234 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 13:57:04.235 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 13:57:04.235 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 13:57:04.235 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 13:57:04.918 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 3aeb61c2-abcb-4efb-a1cd-b04a89c3aab8, Total Tokens: 1023, Prompt Tokens: 1018, Completion Tokens: 5
2025-09-11 13:57:04.925 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:57:04.926 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 3aeb61c2-abcb-4efb-a1cd-b04a89c3aab8
2025-09-11 13:57:04.926 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 1018, 'total_tokens': 1023, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-bf369748-56bb-4305-a97a-71d740466fb0', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--55f4ca76-cc4e-46c1-9f4f-2fd4ecdf405d-0' usage_metadata={'input_tokens': 1018, 'output_tokens': 5, 'total_tokens': 1023, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 13:57:04.927 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 13:57:04.927 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 13:57:04.928 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 22 | 22 | T0007 | LT00001981 | * | HHYY | 1011000111 | 麝香保心丸,42丸/盒,300盒/箱,每丸重22.5mg |  |  |  | SHPL_待验 |
| WH01 | 10 | 10 | 17-00-002 | LT00079517 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01T00:00:00 | 2024-12-04T00:00:00 |  | SHPL_待验 |
| WH01 | 0 | 0 | TEST022 | LT00001134 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27T00:00:00 | 2023-12-31T00:00:00 |  | SHPL_待验 |
| WH01 | 100 | 0 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06T00:00:00 | 2026-11-30T00:00:00 |  | SHPL_待验 |
| WH01 | 10 | 10 | 17-00-002 | LT00003416 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31T00:00:00 | 2025-02-20T00:00:00 |  |  |
| WH01 | 0 | 287000 | 17-00-001 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05T00:00:00 | 2024-03-31T00:00:00 | 2023-02-08T00:00:00 | SHPL_待处理 |
| WH01 | 0 | 0 | 01 | LT00002000 | 05-16-01 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  |
| WH01 | 10 | 10 | 17-00-002 | LT00003338 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31T00:00:00 | 2024-11-22T00:00:00 |  |  |
| WH01 | 100 | 100 | 03-02-038 | LT00002178 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00066 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00065 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00081 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 4000 | 4000 | 01002006 | LT00000167 | BCR00051-ZK2 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-03-21T00:00:00 | SHPL_待验 |
| WH01 | 6000 | 0 | 01004004 | LT00000151 | BCR00080 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 9900 | 9900 | 001 | LT00000494 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2020-03-03T00:00:00 | 2023-02-28T00:00:00 | 2023-02-27T00:00:00 | SHPL_合格 |
| WH01 | 0 | 6000 | 01005005 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 20 | 0 | 001 | LT00000147 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-04-13T00:00:00 | 2024-05-31T00:00:00 | 2023-03-02T00:00:00 | 有效 |
| WH01 | 6000 | 0 | 01003006 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 6000 | 0 | 01010001 | LT00000227 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09T00:00:00 | SHPL_合格 |
| WH01 | 0 | 6000 | 01030006 | LT00000226 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09T00:00:00 | SHPL_合格 |
2025-09-11 13:57:04.928 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 22 | 22 | T0007 | LT00001981 | * | HHYY | 1011000111 | 麝香保心丸,42丸/盒,300盒/箱,每丸重22.5mg |  |  |  | SHPL_待验 |
| WH01 | 10 | 10 | 17-00-002 | LT00079517 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01T00:00:00 | 2024-12-04T00:00:00 |  | SHPL_待验 |
| WH01 | 0 | 0 | TEST022 | LT00001134 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27T00:00:00 | 2023-12-31T00:00:00 |  | SHPL_待验 |
| WH01 | 100 | 0 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06T00:00:00 | 2026-11-30T00:00:00 |  | SHPL_待验 |
| WH01 | 10 | 10 | 17-00-002 | LT00003416 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31T00:00:00 | 2025-02-20T00:00:00 |  |  |
| WH01 | 0 | 287000 | 17-00-001 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05T00:00:00 | 2024-03-31T00:00:00 | 2023-02-08T00:00:00 | SHPL_待处理 |
| WH01 | 0 | 0 | 01 | LT00002000 | 05-16-01 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  |
| WH01 | 10 | 10 | 17-00-002 | LT00003338 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31T00:00:00 | 2024-11-22T00:00:00 |  |  |
| WH01 | 100 | 100 | 03-02-038 | LT00002178 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00066 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00065 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 0 | 6000 | TEST009 | LT00000151 | BCR00081 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 4000 | 4000 | 01002006 | LT00000167 | BCR00051-ZK2 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-03-21T00:00:00 | SHPL_待验 |
| WH01 | 6000 | 0 | 01004004 | LT00000151 | BCR00080 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 9900 | 9900 | 001 | LT00000494 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2020-03-03T00:00:00 | 2023-02-28T00:00:00 | 2023-02-27T00:00:00 | SHPL_合格 |
| WH01 | 0 | 6000 | 01005005 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 20 | 0 | 001 | LT00000147 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-04-13T00:00:00 | 2024-05-31T00:00:00 | 2023-03-02T00:00:00 | 有效 |
| WH01 | 6000 | 0 | 01003006 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22T00:00:00 | 2025-09-30T00:00:00 |  | SHPL_待验 |
| WH01 | 6000 | 0 | 01010001 | LT00000227 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09T00:00:00 | SHPL_合格 |
| WH01 | 0 | 6000 | 01030006 | LT00000226 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09T00:00:00 | SHPL_合格 | ---
2025-09-11 13:57:04.928 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 13:57:04.930 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 13:57:04.933 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 13:57:04.933 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 13:57:04.934 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 13:57:04.937 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 13:57:04.950 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 115 ---
2025-09-11 13:57:04.963 | ce8d87d42cba44d9ac3467025dcd38ee | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 116 ---
2025-09-11 13:57:04.963 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 13:57:05.050 | ce8d87d42cba44d9ac3467025dcd38ee | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 13:59:31.920 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 13:59:31.920 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 13:59:31.921 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 陈皮的库存情况

2025-09-11 13:59:31.921 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 13:59:31.922 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 13:59:31.923 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 386)
2025-09-11 13:59:31.923 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiOTA2NTVmMTYtZGZlZi00OTVmLThiNzUtMjZmNzBjOGQ5MDM5IiwiaWF0IjoxNzU3NTcwMjUxLCJleHAiOjE3NTc1NzA4NTF9.jpWOOj6NooxXWU1kZ3EwPb7xXEy5b8tIj2sdxD-zLgI', 'Signature': 'd41380cedb9a6daed2eee61b4260bcd1', 'Message': '%E9%99%88%E7%9A%AE%E7%9A%84%E5%BA%93%E5%AD%98%E6%83%85%E5%86%B5%0A'}
2025-09-11 13:59:39.955 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 13:59:39.992 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 77 (<= 1000), 执行全量查询.
2025-09-11 13:59:40.020 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/9611bb31-9974-499f-90fe-ce3bac1c8928.xlsx
2025-09-11 13:59:40.050 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/9611bb31-9974-499f-90fe-ce3bac1c8928.xlsx
2025-09-11 13:59:40.052 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 13:59:40.053 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 13:59:40.056 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 13:59:40.057 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 13:59:40.060 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 13:59:40.060 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 13:59:40.060 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 13:59:40.061 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 13:59:40.600 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 1012, Prompt Tokens: 1007, Completion Tokens: 5
2025-09-11 13:59:40.610 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 13:59:40.610 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 13:59:40.611 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 1007, 'total_tokens': 1012, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-d2547338-fcc3-456f-bfcf-633a7667e007', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--3f1d2602-85cc-4d1e-a648-58305aea6636-0' usage_metadata={'input_tokens': 1007, 'output_tokens': 5, 'total_tokens': 1012, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 13:59:40.612 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 13:59:40.612 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 13:59:40.613 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 01 | LT00000572 | PN001 | HHYY | 3000111 | 陈皮(净) |  |  |  | SHPL_合格 | 0 | 0 |
| WH01 | 08-01-001 | LT00002328 | * | HHYY | 3000111 | 陈皮(净) | 2023-11-03 | 2025-10-23 |  | SHPL_合格 | 100 | 100 |
| WH01 | STAGE_WH01 | LT00002460 | 00017965 | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
| WH01 | STAGE_WH01 | LT00001543 | 00444444 | HHYY | 3000111 | 陈皮(净) |  |  |  | SHPL_待验 | 0 | 1600 |
| WH01 | STAGE_WH01 | LT00002460 | 00017966 | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 280 | 280 |
| WH01 | STAGE_WH01 | LT00002460 | 00017901 | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
| WH01 | 08-08-010 | LT00002284 | * | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
| WH01 | STAGE_WH01 | LT00095506 | 2508010000019 | HHYY | 3000111 | 陈皮(净) |  |  |  | SHPL_待验 | 1000 | 0 |
| WH01 | STAGE_WH01 | LT00002257 | * | HHYY | 3000111 | 陈皮(净) | 2024-01-22 | 2027-08-28 |  | SHPL_待处理 | 10 | 0 |
| WH01 | 08-01-006 | LT00000453 | * | HHYY | 3000111 | 陈皮(净) | 2023-06-25 | 2025-06-14 |  | SHPL_合格 | 20 | 0 |
| WH01 | 08-08-004 | LT00002284 | * | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
| WH01 | 01 | LT00095506 | 2508010000019 | HHYY | 3000111 | 陈皮(净) |  |  |  | SHPL_待验 | 0 | 0 |
| WH01 | 08-00-002 | LT00000887 | * | HHYY | 3000111 | 陈皮(净) | 2023-09-27 | 2025-09-16 |  | SHPL_待验 | 319 | 236 |
| WH01 | STAGE_WH01 | LT00001709 | STAGE_WH01 | HHYY | 3000111 | 陈皮(净) |  |  |  | SHPL_待验 | 1 | 0 |
| WH01 | 08-08-001 | LT00002284 | * | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
| WH01 | SORTATION_WH01 | LT00001118 | 00019830 | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 199 | 0 |
| WH01 | 08-01-045 | LT00001737 | * | HHYY | 3000111 | 陈皮(净) | 2023-11-29 | 2024-02-29 |  | SHPL_不合格 | 500 | 500 |
| WH01 | STAGE_WH01 | LT00001327 | 07-20-03 | HHYY | 3000111 | 陈皮(净) | 2025-04-09 | 2027-03-30 |  | SHPL_待验 | 20 | 0 |
| WH01 | 08-05-001 | LT00001861 | * | HHYY | 3000111 | 陈皮(净) | 2024-01-22 | 2024-02-28 |  | SHPL_待处理 | 20 | 20 |
| WH01 | STAGE_WH01 | LT00002460 | 00017907 | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
2025-09-11 13:59:40.613 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 01 | LT00000572 | PN001 | HHYY | 3000111 | 陈皮(净) |  |  |  | SHPL_合格 | 0 | 0 |
| WH01 | 08-01-001 | LT00002328 | * | HHYY | 3000111 | 陈皮(净) | 2023-11-03 | 2025-10-23 |  | SHPL_合格 | 100 | 100 |
| WH01 | STAGE_WH01 | LT00002460 | 00017965 | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
| WH01 | STAGE_WH01 | LT00001543 | 00444444 | HHYY | 3000111 | 陈皮(净) |  |  |  | SHPL_待验 | 0 | 1600 |
| WH01 | STAGE_WH01 | LT00002460 | 00017966 | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 280 | 280 |
| WH01 | STAGE_WH01 | LT00002460 | 00017901 | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
| WH01 | 08-08-010 | LT00002284 | * | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
| WH01 | STAGE_WH01 | LT00095506 | 2508010000019 | HHYY | 3000111 | 陈皮(净) |  |  |  | SHPL_待验 | 1000 | 0 |
| WH01 | STAGE_WH01 | LT00002257 | * | HHYY | 3000111 | 陈皮(净) | 2024-01-22 | 2027-08-28 |  | SHPL_待处理 | 10 | 0 |
| WH01 | 08-01-006 | LT00000453 | * | HHYY | 3000111 | 陈皮(净) | 2023-06-25 | 2025-06-14 |  | SHPL_合格 | 20 | 0 |
| WH01 | 08-08-004 | LT00002284 | * | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
| WH01 | 01 | LT00095506 | 2508010000019 | HHYY | 3000111 | 陈皮(净) |  |  |  | SHPL_待验 | 0 | 0 |
| WH01 | 08-00-002 | LT00000887 | * | HHYY | 3000111 | 陈皮(净) | 2023-09-27 | 2025-09-16 |  | SHPL_待验 | 319 | 236 |
| WH01 | STAGE_WH01 | LT00001709 | STAGE_WH01 | HHYY | 3000111 | 陈皮(净) |  |  |  | SHPL_待验 | 1 | 0 |
| WH01 | 08-08-001 | LT00002284 | * | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 |
| WH01 | SORTATION_WH01 | LT00001118 | 00019830 | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 199 | 0 |
| WH01 | 08-01-045 | LT00001737 | * | HHYY | 3000111 | 陈皮(净) | 2023-11-29 | 2024-02-29 |  | SHPL_不合格 | 500 | 500 |
| WH01 | STAGE_WH01 | LT00001327 | 07-20-03 | HHYY | 3000111 | 陈皮(净) | 2025-04-09 | 2027-03-30 |  | SHPL_待验 | 20 | 0 |
| WH01 | 08-05-001 | LT00001861 | * | HHYY | 3000111 | 陈皮(净) | 2024-01-22 | 2024-02-28 |  | SHPL_待处理 | 20 | 20 |
| WH01 | STAGE_WH01 | LT00002460 | 00017907 | HHYY | 3000111 | 陈皮(净) | 2023-08-16 | 2025-08-05 |  | SHPL_合格 | 320 | 320 | ---
2025-09-11 13:59:40.613 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 13:59:40.616 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 13:59:40.619 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 13:59:40.619 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 13:59:40.619 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 13:59:40.622 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 13:59:40.635 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 117 ---
2025-09-11 13:59:40.646 | 6f9e2160ff704f2fa4f74fd7743cc0dd | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 118 ---
2025-09-11 13:59:40.647 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 13:59:40.737 | 6f9e2160ff704f2fa4f74fd7743cc0dd | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:12:29.772 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:12:29.773 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:12:29.867 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:12:29.879 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 118 ---
2025-09-11 14:12:29.879 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:12:29.882 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:12:31.185 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 3351, Prompt Tokens: 3330, Completion Tokens: 21
2025-09-11 14:12:31.194 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:12:31.195 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 14:12:31.196 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:12:31.197 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:12:31.198 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:12:31.198 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:12:31.200 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:12:31.201 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:12:31.206 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:12:31.206 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:12:31.207 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 1011000112有多少库存
2025-09-11 14:12:31.207 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:12:31.208 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:12:31.208 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 375)
2025-09-11 14:12:31.208 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiMGYxNjdhY2YtYjFiNC00YmRkLWJkMWItMTc4MTBmYjY4MmFmIiwiaWF0IjoxNzU3NTcxMDMxLCJleHAiOjE3NTc1NzE2MzF9.LAmUy0T2lmFIfFdTnbbvFF6yGFVZlBgrBbh0I92yt4s', 'Signature': '7a8a7247f4a42bab7aa4405eb0324131', 'Message': '1011000112%E6%9C%89%E5%A4%9A%E5%B0%91%E5%BA%93%E5%AD%98'}
2025-09-11 14:12:39.021 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:12:39.034 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 58 (<= 1000), 执行全量查询.
2025-09-11 14:12:39.046 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/26fdebff-05c6-4ab8-9885-407f39c07950.xlsx
2025-09-11 14:12:39.076 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/26fdebff-05c6-4ab8-9885-407f39c07950.xlsx
2025-09-11 14:12:39.077 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:12:39.078 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 14:12:39.080 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 14:12:39.080 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 14:12:39.082 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 14:12:39.083 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 14:12:39.083 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 14:12:39.083 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 14:12:39.794 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 1019, Prompt Tokens: 1014, Completion Tokens: 5
2025-09-11 14:12:39.803 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:12:39.804 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 14:12:39.805 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 1014, 'total_tokens': 1019, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-8a52d730-7fa6-4612-a782-ca92bb72b815', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--31b1445d-eef9-44de-b94c-aadb530955a4-0' usage_metadata={'input_tokens': 1014, 'output_tokens': 5, 'total_tokens': 1019, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 14:12:39.806 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 14:12:39.806 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 14:12:39.806 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 02 | LT00000045 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 83 | 0 |
| WH01 | 001 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 9954 | 0 |
| WH01 | DYNAMIC_AP_WH01 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 0 | 9954 |
| WH01 | TEST022 | LT00001136 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 0 | 0 |
| WH01 | 01 | LT00002103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00003339 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2025-03-02 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079534 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2024-09-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 17-00-002 | LT00079513 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-06 |  | SHPL_待验 | 10 | 10 |
| WH01 | SORTATION_WH01 | LT00000121 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-02-28 | 2026-02-12 | 2023-02-28 | SHPL_待验 | 11 | 0 |
| WH01 | 001 | LT00000046 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 1101 | 1101 |
| WH01 | 17-00-002 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 917 | 917 |
| WH01 | 07-001-003 | LT00002001 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00002542 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-20 | 2026-08-21 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079518 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 | 19764 | 0 |
| WH01 | BHG004 | LT00000234 | ZK0512 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  | 2023-05-12 | SHPL_待验 | 800 | 799 |
| WH01 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 1 | 0 |
| WH01 | 01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 100 | 0 |
2025-09-11 14:12:39.807 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 02 | LT00000045 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 83 | 0 |
| WH01 | 001 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 9954 | 0 |
| WH01 | DYNAMIC_AP_WH01 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 0 | 9954 |
| WH01 | TEST022 | LT00001136 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 0 | 0 |
| WH01 | 01 | LT00002103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00003339 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2025-03-02 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079534 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2024-09-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 17-00-002 | LT00079513 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-06 |  | SHPL_待验 | 10 | 10 |
| WH01 | SORTATION_WH01 | LT00000121 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-02-28 | 2026-02-12 | 2023-02-28 | SHPL_待验 | 11 | 0 |
| WH01 | 001 | LT00000046 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 1101 | 1101 |
| WH01 | 17-00-002 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 917 | 917 |
| WH01 | 07-001-003 | LT00002001 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00002542 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-20 | 2026-08-21 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079518 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 | 19764 | 0 |
| WH01 | BHG004 | LT00000234 | ZK0512 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  | 2023-05-12 | SHPL_待验 | 800 | 799 |
| WH01 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 1 | 0 |
| WH01 | 01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 100 | 0 | ---
2025-09-11 14:12:39.807 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 14:12:39.809 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 14:12:39.811 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:12:39.811 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:12:39.811 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 14:12:39.814 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:12:39.825 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 119 ---
2025-09-11 14:12:39.836 | ad0ffeaa50ac43289f133b9b064625b7 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 120 ---
2025-09-11 14:12:39.837 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:12:39.949 | ad0ffeaa50ac43289f133b9b064625b7 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:14:02.067 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:14:02.068 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:14:02.162 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:14:02.171 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 120 ---
2025-09-11 14:14:02.172 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:14:02.174 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:14:03.668 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 6207, Prompt Tokens: 6186, Completion Tokens: 21
2025-09-11 14:14:03.677 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:14:03.677 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 14:14:03.679 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:14:03.679 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:14:03.680 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:14:03.680 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:14:03.683 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:14:03.683 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:14:03.688 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:14:03.688 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:14:03.689 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 1011000112的出库情况
2025-09-11 14:14:03.689 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:14:03.690 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:14:03.690 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 375)
2025-09-11 14:14:03.690 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiZWIzNWQyM2EtNDM4NS00Yzc3LWFhMDgtYzE4NjFmMmM1ZGQzIiwiaWF0IjoxNzU3NTcxMTIzLCJleHAiOjE3NTc1NzE3MjN9.9pf11L9au8MNBagjHAW5BNmfNJeT_hjhyaW__JAlP44', 'Signature': '942d29f5ae87ad852369598163b6b278', 'Message': '1011000112%E7%9A%84%E5%87%BA%E5%BA%93%E6%83%85%E5%86%B5'}
2025-09-11 14:14:11.145 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:14:11.173 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 0 (<= 1000), 执行全量查询.
2025-09-11 14:14:11.197 | 8c72a5999ea84528b1efc90303f36ca8 | ERROR    | utils.excel_util:generate_excel_file:128 - 尝试生成Excel文件，但查询结果为空
2025-09-11 14:14:11.197 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:125 - --- Leave node: Data Query ---
2025-09-11 14:14:11.198 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:14:11.199 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 14:14:11.201 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:14:11.202 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:14:11.202 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:313 - --- Leave node: Combine Data ---
2025-09-11 14:14:11.204 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:14:11.215 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 121 ---
2025-09-11 14:14:11.228 | 8c72a5999ea84528b1efc90303f36ca8 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 122 ---
2025-09-11 14:14:11.228 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:14:11.319 | 8c72a5999ea84528b1efc90303f36ca8 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:14:35.285 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:14:35.285 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:14:35.376 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:14:35.387 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 122 ---
2025-09-11 14:14:35.387 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:14:35.390 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:14:36.905 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 4242, Prompt Tokens: 4221, Completion Tokens: 21
2025-09-11 14:14:36.914 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:14:36.914 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 14:14:36.916 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:14:36.916 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:14:36.917 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:14:36.917 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:14:36.920 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:14:36.921 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:14:36.926 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:14:36.926 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:14:36.927 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 最近一笔的出库情况
2025-09-11 14:14:36.927 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:14:36.928 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:14:36.928 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 401)
2025-09-11 14:14:36.928 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiNWNjMThhZWQtOTgzNC00Y2I1LTg0MzEtYmRiZTdhNzBmYWVhIiwiaWF0IjoxNzU3NTcxMTU2LCJleHAiOjE3NTc1NzE3NTZ9.A49rtgMENlpMkgMcKMfc0uDJNF0pgyGgBd_rbumYur0', 'Signature': 'd68b5a2e36a648a1530facbc5b2ba90b', 'Message': '%E6%9C%80%E8%BF%91%E4%B8%80%E7%AC%94%E7%9A%84%E5%87%BA%E5%BA%93%E6%83%85%E5%86%B5'}
2025-09-11 14:14:45.531 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:14:45.545 | d451742636184b648ac2aea7e13ff5e1 | ERROR    | apps.module_business.service.business_service:search_data_from_sql:154 - 执行sql出错: (oracledb.exceptions.DatabaseError) ORA-00937: not a single-group group function
Help: https://docs.oracle.com/error-help/db/ora-00937/
[SQL: SELECT COUNT(*) count FROM ( SELECT DOH.orderNo AS 订单号,        BSM_CODE_ML.codeDescr AS 订单类型,        BSM_CODE_ML.codeDescr AS 订单状态,        DOH.consigneeName AS 收货人名称,        DOH.consigneeAddress1 AS 收货地址,        SUM(DOD.qtyShipped_Each) AS 订单数量 FROM DOC_ORDER_HEADER DOH INNER JOIN DOC_ORDER_DETAILS DOD ON DOH.organizationId = DOD.organizationId AND DOH.warehouseId = DOD.warehouseId AND DOH.orderNo = DOD.orderNo INNER JOIN BSM_CODE_ML ON DOH.orderType = BSM_CODE_ML.codeId AND BSM_CODE_ML.codeType = 'SO_TYP' AND DOH.organizationId = BSM_CODE_ML.organizationId AND BSM_CODE_ML.languageId = 'zh_CN' WHERE DOH.warehouseId = 'WH01' AND DOH.organizationId = 'HHYY' ORDER BY DOH.orderTime DESC FETCH FIRST 1 ROWS ONLY) t]
(Background on this error at: https://sqlalche.me/e/20/4xp6)
2025-09-11 14:14:45.545 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:118 - --- Leave node: Data Query ---
2025-09-11 14:14:45.546 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:14:45.547 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 14:14:45.548 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:14:45.549 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:14:45.549 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:306 - --- Leave node: Combine Data ---
2025-09-11 14:14:45.551 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:14:45.566 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 123 ---
2025-09-11 14:14:45.577 | d451742636184b648ac2aea7e13ff5e1 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 124 ---
2025-09-11 14:14:45.577 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:14:45.681 | d451742636184b648ac2aea7e13ff5e1 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:15:17.944 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:15:17.944 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:15:18.058 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:15:18.067 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 124 ---
2025-09-11 14:15:18.067 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:15:18.069 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:15:19.272 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 1646, Prompt Tokens: 1625, Completion Tokens: 21
2025-09-11 14:15:19.282 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:15:19.283 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 14:15:19.285 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:15:19.285 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:15:19.286 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:15:19.287 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:15:19.289 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:15:19.289 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:15:19.294 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:15:19.295 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:15:19.295 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 最近一笔的入库情况
2025-09-11 14:15:19.296 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:15:19.296 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:15:19.297 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 401)
2025-09-11 14:15:19.297 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiYTRmMzNkZjAtMDg1Ny00MTg0LWI1OTItNzZkZTYwYTY2MGJhIiwiaWF0IjoxNzU3NTcxMTk5LCJleHAiOjE3NTc1NzE3OTl9.9rPEoWeCEIG8Dh2zLVXPjEoIiAn4AureSrshCTTzrMg', 'Signature': 'fedb85cd311f30ee694025ce93dfbba7', 'Message': '%E6%9C%80%E8%BF%91%E4%B8%80%E7%AC%94%E7%9A%84%E5%85%A5%E5%BA%93%E6%83%85%E5%86%B5'}
2025-09-11 14:15:24.313 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:15:24.321 | 306c167f7b8747b19285fb292f56d1e3 | ERROR    | apps.module_business.service.business_service:search_data_from_sql:154 - 执行sql出错: (oracledb.exceptions.DatabaseError) ORA-00937: not a single-group group function
Help: https://docs.oracle.com/error-help/db/ora-00937/
[SQL: SELECT COUNT(*) count FROM ( SELECT DAH.asnNo AS 预期到货通知编号,        BSM_CODE_ML.codeDescr AS 订单状态,        DAH.supplierName AS 供应商名称,        SUM(DAD.expectedQty_Each) AS 预期数量 FROM DOC_ASN_HEADER DAH LEFT JOIN DOC_ASN_DETAILS DAD ON DAH.organizationId = DAD.organizationId                               AND DAH.warehouseId = DAD.warehouseId                               AND DAH.asnNo = DAD.asnNo LEFT JOIN BSM_CODE_ML ON DAH.asnStatus = BSM_CODE_ML.codeId                       AND BSM_CODE_ML.codeType = 'ASN_STS'                       AND DAH.organizationId = BSM_CODE_ML.organizationId                       AND BSM_CODE_ML.languageId = 'zh_CN' WHERE DAH.warehouseId = 'WH01'   AND DAH.organizationId = 'HHYY' ORDER BY DAH.asnCreationTime DESC FETCH FIRST 1 ROW ONLY) t]
(Background on this error at: https://sqlalche.me/e/20/4xp6)
2025-09-11 14:15:24.321 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:118 - --- Leave node: Data Query ---
2025-09-11 14:15:24.323 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:15:24.323 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 14:15:24.326 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:15:24.326 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:15:24.326 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:306 - --- Leave node: Combine Data ---
2025-09-11 14:15:24.330 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:15:24.342 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 125 ---
2025-09-11 14:15:24.352 | 306c167f7b8747b19285fb292f56d1e3 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 126 ---
2025-09-11 14:15:24.352 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:15:24.444 | 306c167f7b8747b19285fb292f56d1e3 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:16:29.075 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:16:29.076 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:16:29.182 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:16:29.192 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 126 ---
2025-09-11 14:16:29.192 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:16:29.194 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:16:30.160 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 1544, Prompt Tokens: 1523, Completion Tokens: 21
2025-09-11 14:16:30.169 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:16:30.169 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 14:16:30.171 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:16:30.172 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:16:30.173 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:16:30.174 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:16:30.176 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:16:30.176 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:16:30.181 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:16:30.181 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:16:30.182 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 1011000112 有多少合格的库存
2025-09-11 14:16:30.182 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:16:30.183 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:16:30.183 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 403)
2025-09-11 14:16:30.184 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiMDYyMDdlODMtYjc0Zi00YjM3LWE2N2UtZTNjMzU0NWE4ODE0IiwiaWF0IjoxNzU3NTcxMjcwLCJleHAiOjE3NTc1NzE4NzB9.D2kCts5TdfZTDldbgJS0qjZcjsUiqyfsbbAU5eyXwY0', 'Signature': '4265b19feaf251cc64db9508b8fad0e3', 'Message': '1011000112 %E6%9C%89%E5%A4%9A%E5%B0%91%E5%90%88%E6%A0%BC%E7%9A%84%E5%BA%93%E5%AD%98'}
2025-09-11 14:16:39.368 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:16:39.380 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 58 (<= 1000), 执行全量查询.
2025-09-11 14:16:39.392 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/292b6a44-c6c8-402b-b17f-a0aec4b4db53.xlsx
2025-09-11 14:16:39.419 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/292b6a44-c6c8-402b-b17f-a0aec4b4db53.xlsx
2025-09-11 14:16:39.420 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:16:39.420 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 14:16:39.422 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 14:16:39.423 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 14:16:39.424 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 14:16:39.424 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 14:16:39.424 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 14:16:39.425 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 14:16:39.957 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 1043, Prompt Tokens: 1038, Completion Tokens: 5
2025-09-11 14:16:39.965 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:16:39.965 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 14:16:39.966 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 1038, 'total_tokens': 1043, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-7c1f0001-e5ff-43fd-b793-91eb703b576c', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--88c0e54a-df84-4150-807f-9cac57f90f7d-0' usage_metadata={'input_tokens': 1038, 'output_tokens': 5, 'total_tokens': 1043, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 14:16:39.966 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 14:16:39.966 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 14:16:39.967 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 02 | LT00000045 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05T00:00:00 | 2024-03-31T00:00:00 | 2023-02-08T00:00:00 | SHPL_待处理 | 83 | 0 |
| WH01 | 001 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27T00:00:00 | 2023-12-31T00:00:00 | 2023-02-24T00:00:00 | SHPL_待验 | 9954 | 0 |
| WH01 | DYNAMIC_AP_WH01 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27T00:00:00 | 2023-12-31T00:00:00 | 2023-02-24T00:00:00 | SHPL_待验 | 0 | 9954 |
| WH01 | TEST022 | LT00001136 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 0 | 0 |
| WH01 | 01 | LT00002103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00003339 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31T00:00:00 | 2025-03-02T00:00:00 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079534 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01T00:00:00 | 2024-09-05T00:00:00 |  | SHPL_待验 | 10 | 10 |
| WH01 | 17-00-002 | LT00079513 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01T00:00:00 | 2025-03-06T00:00:00 |  | SHPL_待验 | 10 | 10 |
| WH01 | SORTATION_WH01 | LT00000121 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-02-28T00:00:00 | 2026-02-12T00:00:00 | 2023-02-28T00:00:00 | SHPL_待验 | 11 | 0 |
| WH01 | 001 | LT00000046 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05T00:00:00 | 2024-03-31T00:00:00 | 2023-02-08T00:00:00 | SHPL_待处理 | 1101 | 1101 |
| WH01 | 17-00-002 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05T00:00:00 | 2024-03-31T00:00:00 | 2023-02-08T00:00:00 | SHPL_待处理 | 917 | 917 |
| WH01 | 07-001-003 | LT00002001 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00002542 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-20T00:00:00 | 2026-08-21T00:00:00 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079518 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01T00:00:00 | 2025-03-05T00:00:00 |  | SHPL_待验 | 10 | 10 |
| WH01 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08T00:00:00 | 2024-02-29T00:00:00 | 2023-02-21T00:00:00 | SHPL_不合格 | 19764 | 0 |
| WH01 | BHG004 | LT00000234 | ZK0512 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  | 2023-05-12T00:00:00 | SHPL_待验 | 800 | 799 |
| WH01 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 | 1 | 0 |
| WH01 | 01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06T00:00:00 | 2026-11-30T00:00:00 |  | SHPL_待验 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06T00:00:00 | 2026-11-30T00:00:00 |  | SHPL_待验 | 100 | 0 |
2025-09-11 14:16:39.967 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 02 | LT00000045 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05T00:00:00 | 2024-03-31T00:00:00 | 2023-02-08T00:00:00 | SHPL_待处理 | 83 | 0 |
| WH01 | 001 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27T00:00:00 | 2023-12-31T00:00:00 | 2023-02-24T00:00:00 | SHPL_待验 | 9954 | 0 |
| WH01 | DYNAMIC_AP_WH01 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27T00:00:00 | 2023-12-31T00:00:00 | 2023-02-24T00:00:00 | SHPL_待验 | 0 | 9954 |
| WH01 | TEST022 | LT00001136 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 0 | 0 |
| WH01 | 01 | LT00002103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00003339 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31T00:00:00 | 2025-03-02T00:00:00 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079534 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01T00:00:00 | 2024-09-05T00:00:00 |  | SHPL_待验 | 10 | 10 |
| WH01 | 17-00-002 | LT00079513 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01T00:00:00 | 2025-03-06T00:00:00 |  | SHPL_待验 | 10 | 10 |
| WH01 | SORTATION_WH01 | LT00000121 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-02-28T00:00:00 | 2026-02-12T00:00:00 | 2023-02-28T00:00:00 | SHPL_待验 | 11 | 0 |
| WH01 | 001 | LT00000046 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05T00:00:00 | 2024-03-31T00:00:00 | 2023-02-08T00:00:00 | SHPL_待处理 | 1101 | 1101 |
| WH01 | 17-00-002 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05T00:00:00 | 2024-03-31T00:00:00 | 2023-02-08T00:00:00 | SHPL_待处理 | 917 | 917 |
| WH01 | 07-001-003 | LT00002001 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00002542 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-20T00:00:00 | 2026-08-21T00:00:00 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079518 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01T00:00:00 | 2025-03-05T00:00:00 |  | SHPL_待验 | 10 | 10 |
| WH01 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08T00:00:00 | 2024-02-29T00:00:00 | 2023-02-21T00:00:00 | SHPL_不合格 | 19764 | 0 |
| WH01 | BHG004 | LT00000234 | ZK0512 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  | 2023-05-12T00:00:00 | SHPL_待验 | 800 | 799 |
| WH01 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 | 1 | 0 |
| WH01 | 01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06T00:00:00 | 2026-11-30T00:00:00 |  | SHPL_待验 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06T00:00:00 | 2026-11-30T00:00:00 |  | SHPL_待验 | 100 | 0 | ---
2025-09-11 14:16:39.968 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 14:16:39.970 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 14:16:39.972 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:16:39.972 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:16:39.972 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 14:16:39.974 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:16:39.984 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 127 ---
2025-09-11 14:16:39.994 | 45ef4648dfa24123aa0362b00a1bcbb8 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 128 ---
2025-09-11 14:16:39.994 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:16:40.102 | 45ef4648dfa24123aa0362b00a1bcbb8 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:17:55.737 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:17:55.737 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:17:55.843 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:17:55.852 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 128 ---
2025-09-11 14:17:55.853 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:17:55.855 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:17:57.059 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 4534, Prompt Tokens: 4513, Completion Tokens: 21
2025-09-11 14:17:57.068 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:17:57.069 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 14:17:57.070 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:17:57.070 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:17:57.071 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:17:57.071 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:17:57.073 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:17:57.074 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:17:57.077 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:17:57.078 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:17:57.078 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 1011000112 有多少合格的库存
2025-09-11 14:17:57.079 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:17:57.079 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:17:57.079 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 403)
2025-09-11 14:17:57.080 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiNDNmOTQ5OWQtNDM1NS00OTQxLWE3Y2QtNDY1ZTczZDQxYTMxIiwiaWF0IjoxNzU3NTcxMzU3LCJleHAiOjE3NTc1NzE5NTd9.6mnrmhKDIsmlav4qJW-DVHgAi2ljWUhFURpRV929qNc', 'Signature': 'd1ad4cc0a85a2551f4ba2bb600b97bb2', 'Message': '1011000112 %E6%9C%89%E5%A4%9A%E5%B0%91%E5%90%88%E6%A0%BC%E7%9A%84%E5%BA%93%E5%AD%98'}
2025-09-11 14:18:05.585 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:18:05.596 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 58 (<= 1000), 执行全量查询.
2025-09-11 14:18:05.608 | d5e67c1ad17c4431b469542106b016db | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/12672b0b-abad-47c3-8032-c7abe2c3c15a.xlsx
2025-09-11 14:18:05.635 | d5e67c1ad17c4431b469542106b016db | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/12672b0b-abad-47c3-8032-c7abe2c3c15a.xlsx
2025-09-11 14:18:05.637 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:18:05.638 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 14:18:05.640 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 14:18:05.640 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 14:18:05.641 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 14:18:05.641 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 14:18:05.641 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 14:18:05.642 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 14:18:06.309 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 1018, Prompt Tokens: 1013, Completion Tokens: 5
2025-09-11 14:18:06.317 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:18:06.317 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 14:18:06.318 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 1013, 'total_tokens': 1018, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-44d7b6f8-fcb1-41dd-af36-38c1829b1e7f', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--eaa52ab4-8bf3-4c5d-8519-0d00470b320b-0' usage_metadata={'input_tokens': 1013, 'output_tokens': 5, 'total_tokens': 1018, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 14:18:06.319 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 14:18:06.319 | d5e67c1ad17c4431b469542106b016db | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 14:18:06.319 | d5e67c1ad17c4431b469542106b016db | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 02 | LT00000045 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 83 | 0 |
| WH01 | 001 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 9954 | 0 |
| WH01 | DYNAMIC_AP_WH01 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 0 | 9954 |
| WH01 | TEST022 | LT00001136 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 0 | 0 |
| WH01 | 01 | LT00002103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00003339 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2025-03-02 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079534 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2024-09-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 17-00-002 | LT00079513 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-06 |  | SHPL_待验 | 10 | 10 |
| WH01 | SORTATION_WH01 | LT00000121 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-02-28 | 2026-02-12 | 2023-02-28 | SHPL_待验 | 11 | 0 |
| WH01 | 001 | LT00000046 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 1101 | 1101 |
| WH01 | 17-00-002 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 917 | 917 |
| WH01 | 07-001-003 | LT00002001 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00002542 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-20 | 2026-08-21 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079518 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 | 19764 | 0 |
| WH01 | BHG004 | LT00000234 | ZK0512 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  | 2023-05-12 | SHPL_待验 | 800 | 799 |
| WH01 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 1 | 0 |
| WH01 | 01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 100 | 0 |
2025-09-11 14:18:06.320 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 02 | LT00000045 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 83 | 0 |
| WH01 | 001 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 9954 | 0 |
| WH01 | DYNAMIC_AP_WH01 | LT00000103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 | 2023-02-24 | SHPL_待验 | 0 | 9954 |
| WH01 | TEST022 | LT00001136 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 0 | 0 |
| WH01 | 01 | LT00002103 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00003339 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2025-03-02 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079534 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2024-09-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 17-00-002 | LT00079513 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-06 |  | SHPL_待验 | 10 | 10 |
| WH01 | SORTATION_WH01 | LT00000121 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-02-28 | 2026-02-12 | 2023-02-28 | SHPL_待验 | 11 | 0 |
| WH01 | 001 | LT00000046 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 1101 | 1101 |
| WH01 | 17-00-002 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 917 | 917 |
| WH01 | 07-001-003 | LT00002001 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 450 | 450 |
| WH01 | 17-00-002 | LT00002542 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-20 | 2026-08-21 |  |  | 10 | 10 |
| WH01 | 17-00-002 | LT00079518 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2025-03-05 |  | SHPL_待验 | 10 | 10 |
| WH01 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 | 19764 | 0 |
| WH01 | BHG004 | LT00000234 | ZK0512 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  | 2023-05-12 | SHPL_待验 | 800 | 799 |
| WH01 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 | 1 | 0 |
| WH01 | 01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 100 | 0 | ---
2025-09-11 14:18:06.320 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 14:18:06.322 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 14:18:06.326 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:18:06.327 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:18:06.327 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 14:18:06.330 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:18:06.339 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 129 ---
2025-09-11 14:18:06.350 | d5e67c1ad17c4431b469542106b016db | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 130 ---
2025-09-11 14:18:06.350 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:18:06.453 | d5e67c1ad17c4431b469542106b016db | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:19:09.143 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:19:09.143 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:19:09.252 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:19:09.259 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 130 ---
2025-09-11 14:19:09.259 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:19:09.261 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:19:10.880 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c, Total Tokens: 7147, Prompt Tokens: 7126, Completion Tokens: 21
2025-09-11 14:19:10.888 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:19:10.888 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 0051c351-fc10-4306-b814-b915bd200b6c
2025-09-11 14:19:10.890 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:19:10.891 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:19:10.892 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:19:10.893 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:19:10.895 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:19:10.896 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:19:10.900 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:19:10.901 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:19:10.901 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 质量状态为合格的产品1011000112 有多少库存

2025-09-11 14:19:10.902 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:19:10.902 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:19:10.903 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 469)
2025-09-11 14:19:10.903 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiNTRkMTA0ZWQtNzI4ZC00NGVlLWE5MDUtZGJmZGI2MDI2ZmYxIiwiaWF0IjoxNzU3NTcxNDMwLCJleHAiOjE3NTc1NzIwMzB9.nmCERgqybwxB9Wuhe6aAhsdPP05is4dskJSEdxbb4jA', 'Signature': 'd981e912f40b5bff8ffccce59a20bfa1', 'Message': '%E8%B4%A8%E9%87%8F%E7%8A%B6%E6%80%81%E4%B8%BA%E5%90%88%E6%A0%BC%E7%9A%84%E4%BA%A7%E5%93%811011000112 %E6%9C%89%E5%A4%9A%E5%B0%91%E5%BA%93%E5%AD%98%0A'}
2025-09-11 14:19:18.470 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:19:18.498 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 0 (<= 1000), 执行全量查询.
2025-09-11 14:19:18.517 | 6e21214ac0984b52ba26a1b1ce202cf5 | ERROR    | utils.excel_util:generate_excel_file:128 - 尝试生成Excel文件，但查询结果为空
2025-09-11 14:19:18.518 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:125 - --- Leave node: Data Query ---
2025-09-11 14:19:18.519 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:19:18.519 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 14:19:18.521 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:19:18.522 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:19:18.522 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:313 - --- Leave node: Combine Data ---
2025-09-11 14:19:18.524 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:19:18.537 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 131 ---
2025-09-11 14:19:18.550 | 6e21214ac0984b52ba26a1b1ce202cf5 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 132 ---
2025-09-11 14:19:18.550 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:19:18.655 | 6e21214ac0984b52ba26a1b1ce202cf5 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:20:14.969 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:20:14.969 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:20:15.029 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:20:15.040 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 14:20:15.041 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 14:20:15.043 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:20:15.995 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93, Total Tokens: 844, Prompt Tokens: 823, Completion Tokens: 21
2025-09-11 14:20:16.003 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:20:16.004 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93
2025-09-11 14:20:16.006 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:20:16.006 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:20:16.007 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:20:16.007 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:20:16.010 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:20:16.010 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:20:16.014 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:20:16.015 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:20:16.016 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 质量状态为不合格的1011000112 有多少库存

2025-09-11 14:20:16.016 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:20:16.016 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:20:16.017 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 460)
2025-09-11 14:20:16.017 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiYWQ2YzkyMDUtZTRmMC00YWFkLWEwYzMtOGVhM2JkNzViNTc3IiwiaWF0IjoxNzU3NTcxNDk2LCJleHAiOjE3NTc1NzIwOTZ9.hN7hSGK56c8SZBNXQwwoPG_oFM9ggbmeyhktVvyiD8Q', 'Signature': 'afc60837243e3b741feedef7767c7f9f', 'Message': '%E8%B4%A8%E9%87%8F%E7%8A%B6%E6%80%81%E4%B8%BA%E4%B8%8D%E5%90%88%E6%A0%BC%E7%9A%841011000112 %E6%9C%89%E5%A4%9A%E5%B0%91%E5%BA%93%E5%AD%98%0A'}
2025-09-11 14:20:22.882 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:20:22.898 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 0 (<= 1000), 执行全量查询.
2025-09-11 14:20:22.914 | 4af9649fe36b42889ce13c0c2fa1ce0a | ERROR    | utils.excel_util:generate_excel_file:128 - 尝试生成Excel文件，但查询结果为空
2025-09-11 14:20:22.914 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:125 - --- Leave node: Data Query ---
2025-09-11 14:20:22.915 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:20:22.916 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 14:20:22.920 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:20:22.920 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:20:22.921 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:313 - --- Leave node: Combine Data ---
2025-09-11 14:20:22.924 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:20:22.934 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 133 ---
2025-09-11 14:20:22.943 | 4af9649fe36b42889ce13c0c2fa1ce0a | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 134 ---
2025-09-11 14:20:22.943 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:20:23.050 | 4af9649fe36b42889ce13c0c2fa1ce0a | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:23:02.057 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:23:02.058 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:23:02.161 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:23:02.170 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 134 ---
2025-09-11 14:23:02.171 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:23:02.173 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:23:03.825 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93, Total Tokens: 1375, Prompt Tokens: 1354, Completion Tokens: 21
2025-09-11 14:23:03.833 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:23:03.833 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93
2025-09-11 14:23:03.834 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:23:03.835 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:23:03.835 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:23:03.836 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:23:03.839 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:23:03.840 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:23:03.847 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:23:03.848 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:23:03.849 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 质量状态为SHPL_不合格的1011000112 有多少库存

2025-09-11 14:23:03.850 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:23:03.850 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:23:03.851 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 465)
2025-09-11 14:23:03.851 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiY2NkZDFmMWEtMzA4ZS00YjcxLWE5NzctOTAzNmE0NzNmMDA3IiwiaWF0IjoxNzU3NTcxNjYzLCJleHAiOjE3NTc1NzIyNjN9._lBcCR0kFGoxMb1Q68r7TXguP5bpPYfMKJPcrNiC0Ow', 'Signature': '0e1adffeb26a59df241b2bdd283025ef', 'Message': '%E8%B4%A8%E9%87%8F%E7%8A%B6%E6%80%81%E4%B8%BASHPL_%E4%B8%8D%E5%90%88%E6%A0%BC%E7%9A%841011000112 %E6%9C%89%E5%A4%9A%E5%B0%91%E5%BA%93%E5%AD%98%0A'}
2025-09-11 14:23:10.108 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:23:10.131 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 65 (<= 1000), 执行全量查询.
2025-09-11 14:23:10.156 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/40e0f078-9e98-403f-a397-348da46b1c36.xlsx
2025-09-11 14:23:10.184 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/40e0f078-9e98-403f-a397-348da46b1c36.xlsx
2025-09-11 14:23:10.185 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:23:10.185 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 14:23:10.188 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 14:23:10.188 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 14:23:10.189 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 14:23:10.189 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 14:23:10.190 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 14:23:10.190 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 14:23:10.789 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93, Total Tokens: 1004, Prompt Tokens: 999, Completion Tokens: 5
2025-09-11 14:23:10.796 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:23:10.796 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93
2025-09-11 14:23:10.798 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 999, 'total_tokens': 1004, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-162ce06b-5493-4f6a-978a-067db4da409b', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--3a5fceb9-d42e-47ed-b220-25af7667324d-0' usage_metadata={'input_tokens': 999, 'output_tokens': 5, 'total_tokens': 1004, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 14:23:10.798 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 14:23:10.799 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 14:23:10.799 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 99876 | 0 | 001 | LT00001795 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-24T00:00:00 | 2024-01-31T00:00:00 | 2023-02-16T00:00:00 | SHPL_不合格 |
| WH01 | 79 | 0 | 01 | LT00000025 | * | HHYY | 3000071 | 菟丝子(净) | 2023-02-01T00:00:00 | 2023-02-01T00:00:00 | 2023-02-01T00:00:00 | SHPL_不合格 |
| WH01 | 30 | 30 | 08-01-001 | LT00001742 | * | HHYY | 3000121 | 青皮(净) | 2023-11-02T00:00:00 | 2024-01-21T00:00:00 |  | SHPL_不合格 |
| WH01 | 89.4 | 89.4 | 07-05-001 | LT00001805 | * | HHYY | 3000121 | 青皮(净) | 2023-09-27T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 |
| WH01 | 1 | 0 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 |
| WH01 | 19764 | 0 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08T00:00:00 | 2024-02-29T00:00:00 | 2023-02-21T00:00:00 | SHPL_不合格 |
| WH01 | 123 | 0 | SORTATION_WH01 | LT00000056 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-23T00:00:00 | 2024-01-31T00:00:00 | 2023-02-13T00:00:00 | SHPL_不合格 |
| WH01 | 23 | 0 | SORTATION_WH01 | LT00000057 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-24T00:00:00 | 2024-01-31T00:00:00 | 2023-02-13T00:00:00 | SHPL_不合格 |
| WH01 | 686 | 686 | 01028003 | LT00000495 | * | HHYY | 1011000811 | 耳聋左慈丸,每10丸重1克/60g/瓶,200瓶/箱 | 2020-03-26T00:00:00 | 2023-04-01T00:00:00 | 2023-02-15T00:00:00 | SHPL_不合格 |
| WH01 | 30 | 30 | 08-01-001 | LT00001739 | * | HHYY | 3000121 | 青皮(净) | 2023-11-02T00:00:00 | 2024-01-21T00:00:00 |  | SHPL_不合格 |
| WH01 | 10 | 0 | TEST025 | LT00000059 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-23T00:00:00 | 2024-01-31T00:00:00 | 2023-02-13T00:00:00 | SHPL_不合格 |
| WH01 | 8140 | 8140 | 001 | LT00001796 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-23T00:00:00 | 2024-01-31T00:00:00 | 2023-02-13T00:00:00 | SHPL_不合格 |
| WH01 | 23 | 23 | 01 | LT00001802 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-23T00:00:00 | 2024-01-31T00:00:00 | 2023-02-14T00:00:00 | SHPL_不合格 |
| WH01 | 957 | 957 | 001 | LT00001728 | * | HHYY | 1011000811 | 耳聋左慈丸,每10丸重1克/60g/瓶,200瓶/箱 | 2021-01-26T00:00:00 | 2023-12-31T00:00:00 | 2023-02-28T00:00:00 | SHPL_不合格 |
| WH01 | 996 | 996 | 001 | LT00001729 | * | HHYY | 1011000811 | 耳聋左慈丸,每10丸重1克/60g/瓶,200瓶/箱 | 2021-01-25T00:00:00 | 2023-12-31T00:00:00 | 2023-03-02T00:00:00 | SHPL_不合格 |
| WH01 | 20 | 20 | 01-01-001 | LT00002506 | * | HHYY | 3000081 | 栀子(净) | 2024-02-05T00:00:00 | 2026-01-25T00:00:00 |  | SHPL_不合格 |
| WH01 | 7199.2 | 5 | 02-BMG-001 | LT00001533 | * | HHYY | 3000621 | 白茅根(净) | 2021-04-14T00:00:00 | 2023-12-04T00:00:00 |  | SHPL_不合格 |
| WH01 | 49 | 49 | 07-04-001 | LT00000563 | * | HHYY | 3100011 | 玉米淀粉 | 2023-06-30T00:00:00 | 2297-04-13T00:00:00 |  | SHPL_不合格 |
| WH01 | 246 | 246 | 001 | LT00000487 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-09T00:00:00 | 2023-02-25T00:00:00 | 2023-02-14T00:00:00 | SHPL_不合格 |
| WH01 | 9766 | 9766 | 001 | LT00001797 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-23T00:00:00 | 2024-01-31T00:00:00 | 2023-02-13T00:00:00 | SHPL_不合格 |
2025-09-11 14:23:10.800 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 99876 | 0 | 001 | LT00001795 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-24T00:00:00 | 2024-01-31T00:00:00 | 2023-02-16T00:00:00 | SHPL_不合格 |
| WH01 | 79 | 0 | 01 | LT00000025 | * | HHYY | 3000071 | 菟丝子(净) | 2023-02-01T00:00:00 | 2023-02-01T00:00:00 | 2023-02-01T00:00:00 | SHPL_不合格 |
| WH01 | 30 | 30 | 08-01-001 | LT00001742 | * | HHYY | 3000121 | 青皮(净) | 2023-11-02T00:00:00 | 2024-01-21T00:00:00 |  | SHPL_不合格 |
| WH01 | 89.4 | 89.4 | 07-05-001 | LT00001805 | * | HHYY | 3000121 | 青皮(净) | 2023-09-27T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 |
| WH01 | 1 | 0 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 |
| WH01 | 19764 | 0 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08T00:00:00 | 2024-02-29T00:00:00 | 2023-02-21T00:00:00 | SHPL_不合格 |
| WH01 | 123 | 0 | SORTATION_WH01 | LT00000056 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-23T00:00:00 | 2024-01-31T00:00:00 | 2023-02-13T00:00:00 | SHPL_不合格 |
| WH01 | 23 | 0 | SORTATION_WH01 | LT00000057 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-24T00:00:00 | 2024-01-31T00:00:00 | 2023-02-13T00:00:00 | SHPL_不合格 |
| WH01 | 686 | 686 | 01028003 | LT00000495 | * | HHYY | 1011000811 | 耳聋左慈丸,每10丸重1克/60g/瓶,200瓶/箱 | 2020-03-26T00:00:00 | 2023-04-01T00:00:00 | 2023-02-15T00:00:00 | SHPL_不合格 |
| WH01 | 30 | 30 | 08-01-001 | LT00001739 | * | HHYY | 3000121 | 青皮(净) | 2023-11-02T00:00:00 | 2024-01-21T00:00:00 |  | SHPL_不合格 |
| WH01 | 10 | 0 | TEST025 | LT00000059 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-23T00:00:00 | 2024-01-31T00:00:00 | 2023-02-13T00:00:00 | SHPL_不合格 |
| WH01 | 8140 | 8140 | 001 | LT00001796 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-23T00:00:00 | 2024-01-31T00:00:00 | 2023-02-13T00:00:00 | SHPL_不合格 |
| WH01 | 23 | 23 | 01 | LT00001802 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-23T00:00:00 | 2024-01-31T00:00:00 | 2023-02-14T00:00:00 | SHPL_不合格 |
| WH01 | 957 | 957 | 001 | LT00001728 | * | HHYY | 1011000811 | 耳聋左慈丸,每10丸重1克/60g/瓶,200瓶/箱 | 2021-01-26T00:00:00 | 2023-12-31T00:00:00 | 2023-02-28T00:00:00 | SHPL_不合格 |
| WH01 | 996 | 996 | 001 | LT00001729 | * | HHYY | 1011000811 | 耳聋左慈丸,每10丸重1克/60g/瓶,200瓶/箱 | 2021-01-25T00:00:00 | 2023-12-31T00:00:00 | 2023-03-02T00:00:00 | SHPL_不合格 |
| WH01 | 20 | 20 | 01-01-001 | LT00002506 | * | HHYY | 3000081 | 栀子(净) | 2024-02-05T00:00:00 | 2026-01-25T00:00:00 |  | SHPL_不合格 |
| WH01 | 7199.2 | 5 | 02-BMG-001 | LT00001533 | * | HHYY | 3000621 | 白茅根(净) | 2021-04-14T00:00:00 | 2023-12-04T00:00:00 |  | SHPL_不合格 |
| WH01 | 49 | 49 | 07-04-001 | LT00000563 | * | HHYY | 3100011 | 玉米淀粉 | 2023-06-30T00:00:00 | 2297-04-13T00:00:00 |  | SHPL_不合格 |
| WH01 | 246 | 246 | 001 | LT00000487 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-09T00:00:00 | 2023-02-25T00:00:00 | 2023-02-14T00:00:00 | SHPL_不合格 |
| WH01 | 9766 | 9766 | 001 | LT00001797 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-02-23T00:00:00 | 2024-01-31T00:00:00 | 2023-02-13T00:00:00 | SHPL_不合格 | ---
2025-09-11 14:23:10.800 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 14:23:10.802 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 14:23:10.806 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:23:10.806 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:23:10.807 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 14:23:10.810 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:23:10.821 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 135 ---
2025-09-11 14:23:10.830 | ba3f0b32f2284ff985730fbeac9049ce | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 136 ---
2025-09-11 14:23:10.831 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:23:10.948 | ba3f0b32f2284ff985730fbeac9049ce | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:25:22.549 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:25:22.550 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:25:22.667 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:25:22.676 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 136 ---
2025-09-11 14:25:22.676 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:25:22.678 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:25:23.999 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93, Total Tokens: 4754, Prompt Tokens: 4733, Completion Tokens: 21
2025-09-11 14:25:24.009 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:25:24.009 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93
2025-09-11 14:25:24.010 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:25:24.010 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:25:24.011 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:25:24.012 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:25:24.014 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:25:24.014 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:25:24.018 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:25:24.018 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:25:24.019 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 质量状态为SHPL_不合格产品代码为1011000112的物料有多少库存

2025-09-11 14:25:24.019 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:25:24.020 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:25:24.020 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 527)
2025-09-11 14:25:24.020 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiOGRiMDYwNzktZGEyMS00NDcwLTkyYTItMzVkYmNmM2M0YWUyIiwiaWF0IjoxNzU3NTcxODA0LCJleHAiOjE3NTc1NzI0MDR9.pvyoM-XAUY8sI8TzcRTsuEj1u8RC1Sr1ViTbe2hSxoY', 'Signature': '746931d13ac38413a7cd13206c7d7ae0', 'Message': '%E8%B4%A8%E9%87%8F%E7%8A%B6%E6%80%81%E4%B8%BASHPL_%E4%B8%8D%E5%90%88%E6%A0%BC%E4%BA%A7%E5%93%81%E4%BB%A3%E7%A0%81%E4%B8%BA1011000112%E7%9A%84%E7%89%A9%E6%96%99%E6%9C%89%E5%A4%9A%E5%B0%91%E5%BA%93%E5%AD%98%0A'}
2025-09-11 14:25:31.652 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:25:31.668 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 4 (<= 1000), 执行全量查询.
2025-09-11 14:25:31.686 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/2e8b024a-47db-44f2-a3ba-41dbde2a96e0.xlsx
2025-09-11 14:25:31.696 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/2e8b024a-47db-44f2-a3ba-41dbde2a96e0.xlsx
2025-09-11 14:25:31.697 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:25:31.698 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 14:25:31.700 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 14:25:31.700 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 14:25:31.703 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 14:25:31.703 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 14:25:31.703 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 14:25:31.704 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 14:25:32.343 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93, Total Tokens: 1022, Prompt Tokens: 1017, Completion Tokens: 5
2025-09-11 14:25:32.350 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:25:32.350 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93
2025-09-11 14:25:32.351 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 1017, 'total_tokens': 1022, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-2fd953a4-d6c6-42e3-a129-92ae02b31755', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--d7871224-5d2e-4bda-97f8-13b0f22d3e3a-0' usage_metadata={'input_tokens': 1017, 'output_tokens': 5, 'total_tokens': 1022, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 14:25:32.352 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 14:25:32.352 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 14:25:32.353 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共4行）:
| 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 | 1 | 0 |
| WH01 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 | 0 | 0 |
| WH01 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08T00:00:00 | 2024-02-29T00:00:00 | 2023-02-21T00:00:00 | SHPL_不合格 | 19764 | 0 |
| WH01 | 01039006 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08T00:00:00 | 2024-02-29T00:00:00 | 2023-02-21T00:00:00 | SHPL_不合格 | 0 | 19764 |
2025-09-11 14:25:32.353 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 | 1 | 0 |
| WH01 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03T00:00:00 | 2024-02-29T00:00:00 |  | SHPL_不合格 | 0 | 0 |
| WH01 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08T00:00:00 | 2024-02-29T00:00:00 | 2023-02-21T00:00:00 | SHPL_不合格 | 19764 | 0 |
| WH01 | 01039006 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08T00:00:00 | 2024-02-29T00:00:00 | 2023-02-21T00:00:00 | SHPL_不合格 | 0 | 19764 | ---
2025-09-11 14:25:32.353 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 14:25:32.355 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 14:25:32.356 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:25:32.357 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:25:32.357 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 14:25:32.361 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:25:32.372 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 137 ---
2025-09-11 14:25:32.385 | 9012ba6df71c48a8b5b20fad420f80bc | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 138 ---
2025-09-11 14:25:32.386 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:25:32.538 | 9012ba6df71c48a8b5b20fad420f80bc | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:27:48.293 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:27:48.293 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:27:48.399 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:27:48.406 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 138 ---
2025-09-11 14:27:48.406 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:27:48.408 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:27:50.009 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93, Total Tokens: 5515, Prompt Tokens: 5494, Completion Tokens: 21
2025-09-11 14:27:50.017 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:27:50.017 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93
2025-09-11 14:27:50.018 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:27:50.019 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:27:50.020 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:27:50.020 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:27:50.022 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:27:50.023 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:27:50.027 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:27:50.027 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:27:50.028 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 蟾酥的产品代码是多少
2025-09-11 14:27:50.028 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:27:50.029 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:27:50.029 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 410)
2025-09-11 14:27:50.030 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'IT1', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiYTEyMWM4ZGItOGQyZC00OWQyLWFkMGMtMmU5OGQzYTQ5MzMwIiwiaWF0IjoxNzU3NTcxOTUwLCJleHAiOjE3NTc1NzI1NTB9.RRrESVqWUH2CBqI0uLl4MA8jpvCP0JDEUWi0iIwfebo', 'Signature': '3bc62c3481f74be676a0daeab8b913fc', 'Message': '%E8%9F%BE%E9%85%A5%E7%9A%84%E4%BA%A7%E5%93%81%E4%BB%A3%E7%A0%81%E6%98%AF%E5%A4%9A%E5%B0%91'}
2025-09-11 14:27:53.606 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:27:53.616 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 1 (<= 1000), 执行全量查询.
2025-09-11 14:27:53.623 | 6156eda2428942d29486ee9509aa944c | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/dd0dd4cf-30ab-476c-b744-398b9416b1ef.xlsx
2025-09-11 14:27:53.634 | 6156eda2428942d29486ee9509aa944c | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/dd0dd4cf-30ab-476c-b744-398b9416b1ef.xlsx
2025-09-11 14:27:53.635 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:27:53.636 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:68 - --- Data Query Router: Go data analyze ---
2025-09-11 14:27:53.637 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.data_query:data_analyze_node:151 - --- Enter node: Data Analyze ---
2025-09-11 14:27:54.693 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93, Total Tokens: 356, Prompt Tokens: 330, Completion Tokens: 26
2025-09-11 14:27:54.701 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:27:54.702 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: a0c6cf16-41d9-494c-a9a6-2fdb48d61d93
2025-09-11 14:27:54.703 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.graph.node.data_query:data_analyze_node:181 - --- Data Analyze: AI thinking ret: content='```json\n{\n  "analysis_ret": "数据仅含一个产品代码，无其他信息可供分析。"\n}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 26, 'prompt_tokens': 330, 'total_tokens': 356, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-ee3418a9-1322-4568-89f8-13d340aa5ed6', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--557dad3e-5ffc-479b-87b7-9205ac3ee695-0' usage_metadata={'input_tokens': 330, 'output_tokens': 26, 'total_tokens': 356, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}} ---
2025-09-11 14:27:54.704 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.data_query:data_analyze_node:187 - --- Leave node: Data Analyze ---
2025-09-11 14:27:54.707 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:27:54.707 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:27:54.707 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:326 - --- Leave node: Combine Data ---
2025-09-11 14:27:54.709 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:27:54.720 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 139 ---
2025-09-11 14:27:54.730 | 6156eda2428942d29486ee9509aa944c | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 140 ---
2025-09-11 14:27:54.730 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:27:54.858 | 6156eda2428942d29486ee9509aa944c | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:29:56.452 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:29:56.453 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:29:56.515 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:29:56.528 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 14:29:56.528 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 14:29:56.530 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:29:57.290 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 790469be-9c98-4586-b13f-29ded8c51090, Total Tokens: 837, Prompt Tokens: 816, Completion Tokens: 21
2025-09-11 14:29:57.298 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:29:57.298 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 790469be-9c98-4586-b13f-29ded8c51090
2025-09-11 14:29:57.300 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:29:57.300 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:29:57.301 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:29:57.301 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:29:57.303 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:29:57.303 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:29:57.307 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:29:57.307 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:29:57.307 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 3000511有多少库存？
2025-09-11 14:29:57.308 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:29:57.308 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:29:57.308 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 384)
2025-09-11 14:29:57.308 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': '901846', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiNDMzOTNiYmMtNDllYi00MTc1LTg1NjAtZmYxNjY3OWVlM2Q2IiwiaWF0IjoxNzU3NTcyMDc3LCJleHAiOjE3NTc1NzI2Nzd9.qt4_uwndXt-eYlBfP3bc80NkBk5dum9IVYYsuxA9JeU', 'Signature': 'c4c0c84cfaa150988d7e3b02f0aa19f3', 'Message': '3000511%E6%9C%89%E5%A4%9A%E5%B0%91%E5%BA%93%E5%AD%98%EF%BC%9F'}
2025-09-11 14:30:04.115 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:30:04.128 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 95 (<= 1000), 执行全量查询.
2025-09-11 14:30:04.141 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/8f1eb1b7-9faa-4e57-9854-ab13d3361ced.xlsx
2025-09-11 14:30:04.175 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/8f1eb1b7-9faa-4e57-9854-ab13d3361ced.xlsx
2025-09-11 14:30:04.176 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:30:04.177 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 14:30:04.180 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 14:30:04.181 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 14:30:04.184 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 14:30:04.184 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 14:30:04.184 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 14:30:04.185 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 14:30:04.769 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 790469be-9c98-4586-b13f-29ded8c51090, Total Tokens: 1039, Prompt Tokens: 1034, Completion Tokens: 5
2025-09-11 14:30:04.778 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:30:04.778 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 790469be-9c98-4586-b13f-29ded8c51090
2025-09-11 14:30:04.779 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 1034, 'total_tokens': 1039, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-620bceba-cff7-4c84-8574-023159d2baaf', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--abbc7746-8357-42a7-93f7-f3a68845baf5-0' usage_metadata={'input_tokens': 1034, 'output_tokens': 5, 'total_tokens': 1039, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 14:30:04.780 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 14:30:04.781 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 14:30:04.781 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 93.4 | 0 | 07-05-001 | LT00000556 | * | HHYY | 3000511 | 蟾酥 | 2023-06-30T00:00:00 | 2026-06-03T00:00:00 |  | SHPL_合格 |
| WH01 | 10 | 0 | STAGE_WH01 | LT00001300 | WWW1 | HHYY | 3000511 | 蟾酥 |  |  |  | SHPL_待验 |
| WH01 | 0 | 0 | 01 | LT00001300 | 07-19-13 | HHYY | 3000511 | 蟾酥 |  |  |  | SHPL_待验 |
| WH01 | 100 | 100 | 01-01-001 | LT00001960 | * | HHYY | 3000511 | 蟾酥 |  |  |  |  |
| WH01 | 50 | 0 | SORTATION_WH01 | LT00001974 | * | HHYY | 3000511 | 蟾酥 | 2024-02-29T00:00:00 | 2029-02-02T00:00:00 |  | SHPL_合格 |
| WH01 | 320 | 0 | SORTATION_WH01 | LT00030453 | * | HHYY | 3000511 | 蟾酥 | 2024-08-30T00:00:00 | 2029-08-04T00:00:00 |  | SHPL_待验 |
| WH01 | 315 | 315 | 13-02-002 | LT00031192 | * | HHYY | 3000511 | 蟾酥 | 2024-08-27T00:00:00 | 2029-08-01T00:00:00 |  | SHPL_待验 |
| WH01 | 40 | 40 | 13-01-021 | LT00078940 | * | HHYY | 3000511 | 蟾酥 | 2024-05-01T00:00:00 | 2024-10-06T00:00:00 |  | SHPL_待验 |
| WH01 | 40 | 40 | 01-02-001 | LT00009452 | * | HHYY | 3000511 | 蟾酥 | 2024-05-31T00:00:00 | 2025-03-31T00:00:00 |  |  |
| WH01 | 40 | 40 | 01-02-001 | LT00009453 | * | HHYY | 3000511 | 蟾酥 | 2024-05-31T00:00:00 | 2025-03-31T00:00:00 |  |  |
| WH01 | 320 | 320 | 13-02-003 | LT00029224 | * | HHYY | 3000511 | 蟾酥 |  |  |  |  |
| WH01 | 40 | 40 | 13-01-014 | LT00074347 | * | HHYY | 3000511 | 蟾酥 | 2024-05-01T00:00:00 | 2024-12-31T00:00:00 |  | SHPL_待验 |
| WH01 | 29.5 | 0 | SORTATION_WH01 | LT00000555 | 00020534 | HHYY | 3000511 | 蟾酥 | 2023-06-30T00:00:00 | 2026-06-03T00:00:00 |  | SHPL_合格 |
| WH01 | 91.1 | 91.1 | 07-03-001 | LT00000530 | * | HHYY | 3000511 | 蟾酥 | 2024-05-07T00:00:00 | 2029-04-11T00:00:00 |  | SHPL_待验 |
| WH01 | 10 | 10 | 22-01-001 | LT00000902 | * | HHYY | 3000511 | 蟾酥 | 2023-08-08T00:00:00 | 2028-07-12T00:00:00 |  | SHPL_待验 |
| WH01 | 1.6 | 1.6 | 22-01-001 | LT00001153 | * | HHYY | 3000511 | 蟾酥 | 2023-08-08T00:00:00 | 2028-07-12T00:00:00 |  | SHPL_待验 |
| WH01 | 170.3 | 0 | SORTATION_WH01 | LT00001237 | * | HHYY | 3000511 | 蟾酥 | 2023-08-24T00:00:00 | 2028-07-28T00:00:00 |  | SHPL_待验 |
| WH01 | 100 | 100 | 07-001-003 | LT00001621 | * | HHYY | 3000511 | 蟾酥 | 2023-09-27T00:00:00 | 2026-09-27T00:00:00 |  |  |
| WH01 | 1 | 1 | 07-02-001 | LT00001807 | * | HHYY | 3000511 | 蟾酥 | 2024-01-31T00:00:00 | 2029-01-04T00:00:00 |  | SHPL_合格 |
| WH01 | 1 | 1 | 01-01-001 | LT00001959 | * | HHYY | 3000511 | 蟾酥 |  |  |  |  |
2025-09-11 14:30:04.782 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 93.4 | 0 | 07-05-001 | LT00000556 | * | HHYY | 3000511 | 蟾酥 | 2023-06-30T00:00:00 | 2026-06-03T00:00:00 |  | SHPL_合格 |
| WH01 | 10 | 0 | STAGE_WH01 | LT00001300 | WWW1 | HHYY | 3000511 | 蟾酥 |  |  |  | SHPL_待验 |
| WH01 | 0 | 0 | 01 | LT00001300 | 07-19-13 | HHYY | 3000511 | 蟾酥 |  |  |  | SHPL_待验 |
| WH01 | 100 | 100 | 01-01-001 | LT00001960 | * | HHYY | 3000511 | 蟾酥 |  |  |  |  |
| WH01 | 50 | 0 | SORTATION_WH01 | LT00001974 | * | HHYY | 3000511 | 蟾酥 | 2024-02-29T00:00:00 | 2029-02-02T00:00:00 |  | SHPL_合格 |
| WH01 | 320 | 0 | SORTATION_WH01 | LT00030453 | * | HHYY | 3000511 | 蟾酥 | 2024-08-30T00:00:00 | 2029-08-04T00:00:00 |  | SHPL_待验 |
| WH01 | 315 | 315 | 13-02-002 | LT00031192 | * | HHYY | 3000511 | 蟾酥 | 2024-08-27T00:00:00 | 2029-08-01T00:00:00 |  | SHPL_待验 |
| WH01 | 40 | 40 | 13-01-021 | LT00078940 | * | HHYY | 3000511 | 蟾酥 | 2024-05-01T00:00:00 | 2024-10-06T00:00:00 |  | SHPL_待验 |
| WH01 | 40 | 40 | 01-02-001 | LT00009452 | * | HHYY | 3000511 | 蟾酥 | 2024-05-31T00:00:00 | 2025-03-31T00:00:00 |  |  |
| WH01 | 40 | 40 | 01-02-001 | LT00009453 | * | HHYY | 3000511 | 蟾酥 | 2024-05-31T00:00:00 | 2025-03-31T00:00:00 |  |  |
| WH01 | 320 | 320 | 13-02-003 | LT00029224 | * | HHYY | 3000511 | 蟾酥 |  |  |  |  |
| WH01 | 40 | 40 | 13-01-014 | LT00074347 | * | HHYY | 3000511 | 蟾酥 | 2024-05-01T00:00:00 | 2024-12-31T00:00:00 |  | SHPL_待验 |
| WH01 | 29.5 | 0 | SORTATION_WH01 | LT00000555 | 00020534 | HHYY | 3000511 | 蟾酥 | 2023-06-30T00:00:00 | 2026-06-03T00:00:00 |  | SHPL_合格 |
| WH01 | 91.1 | 91.1 | 07-03-001 | LT00000530 | * | HHYY | 3000511 | 蟾酥 | 2024-05-07T00:00:00 | 2029-04-11T00:00:00 |  | SHPL_待验 |
| WH01 | 10 | 10 | 22-01-001 | LT00000902 | * | HHYY | 3000511 | 蟾酥 | 2023-08-08T00:00:00 | 2028-07-12T00:00:00 |  | SHPL_待验 |
| WH01 | 1.6 | 1.6 | 22-01-001 | LT00001153 | * | HHYY | 3000511 | 蟾酥 | 2023-08-08T00:00:00 | 2028-07-12T00:00:00 |  | SHPL_待验 |
| WH01 | 170.3 | 0 | SORTATION_WH01 | LT00001237 | * | HHYY | 3000511 | 蟾酥 | 2023-08-24T00:00:00 | 2028-07-28T00:00:00 |  | SHPL_待验 |
| WH01 | 100 | 100 | 07-001-003 | LT00001621 | * | HHYY | 3000511 | 蟾酥 | 2023-09-27T00:00:00 | 2026-09-27T00:00:00 |  |  |
| WH01 | 1 | 1 | 07-02-001 | LT00001807 | * | HHYY | 3000511 | 蟾酥 | 2024-01-31T00:00:00 | 2029-01-04T00:00:00 |  | SHPL_合格 |
| WH01 | 1 | 1 | 01-01-001 | LT00001959 | * | HHYY | 3000511 | 蟾酥 |  |  |  |  | ---
2025-09-11 14:30:04.782 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 14:30:04.784 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 14:30:04.787 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:30:04.788 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:30:04.788 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 14:30:04.790 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:30:04.799 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 141 ---
2025-09-11 14:30:04.811 | a30f08d843934f089e46e9c9b06a49b9 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 142 ---
2025-09-11 14:30:04.811 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:30:04.925 | a30f08d843934f089e46e9c9b06a49b9 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:43:32.665 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:43:32.665 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:43:32.804 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:43:32.810 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 142 ---
2025-09-11 14:43:32.810 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:43:32.812 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:43:34.205 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 790469be-9c98-4586-b13f-29ded8c51090, Total Tokens: 3452, Prompt Tokens: 3431, Completion Tokens: 21
2025-09-11 14:43:34.214 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:43:34.214 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 790469be-9c98-4586-b13f-29ded8c51090
2025-09-11 14:43:34.215 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:43:34.216 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:43:34.216 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:43:34.217 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:43:34.219 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:43:34.220 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:43:34.223 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:43:34.224 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:43:34.224 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 产品描述为陈皮的库存有多少？
2025-09-11 14:43:34.224 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:43:34.225 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:43:34.225 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 449)
2025-09-11 14:43:34.225 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': '901846', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiODM4MDgwNDgtMzhhZC00ZGE5LTg5MmYtOTU1MTY2YWZlMTEzIiwiaWF0IjoxNzU3NTcyODk0LCJleHAiOjE3NTc1NzM0OTR9.2TBgirTrtUhY0usBWLcSslvT51i_xI6y-wFxS--DagU', 'Signature': 'eb090d3f8b96d9a97a8dd790f91d77b9', 'Message': '%E4%BA%A7%E5%93%81%E6%8F%8F%E8%BF%B0%E4%B8%BA%E9%99%88%E7%9A%AE%E7%9A%84%E5%BA%93%E5%AD%98%E6%9C%89%E5%A4%9A%E5%B0%91%EF%BC%9F'}
2025-09-11 14:43:42.652 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:43:42.667 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 0 (<= 1000), 执行全量查询.
2025-09-11 14:43:42.682 | 60850124acd744f39f5071af8b79249b | ERROR    | utils.excel_util:generate_excel_file:128 - 尝试生成Excel文件，但查询结果为空
2025-09-11 14:43:42.683 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:125 - --- Leave node: Data Query ---
2025-09-11 14:43:42.684 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:43:42.685 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 14:43:42.687 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:43:42.687 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:43:42.687 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:313 - --- Leave node: Combine Data ---
2025-09-11 14:43:42.691 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:43:42.701 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 143 ---
2025-09-11 14:43:42.712 | 60850124acd744f39f5071af8b79249b | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 144 ---
2025-09-11 14:43:42.712 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:43:42.831 | 60850124acd744f39f5071af8b79249b | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:44:28.100 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:44:28.101 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:44:28.225 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:44:28.235 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 144 ---
2025-09-11 14:44:28.236 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:44:28.238 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:44:29.443 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 790469be-9c98-4586-b13f-29ded8c51090, Total Tokens: 3986, Prompt Tokens: 3965, Completion Tokens: 21
2025-09-11 14:44:29.452 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:44:29.452 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 790469be-9c98-4586-b13f-29ded8c51090
2025-09-11 14:44:29.455 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:44:29.456 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:44:29.457 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:44:29.457 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:44:29.459 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:44:29.460 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:44:29.464 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:44:29.465 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:44:29.465 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 产品描述为紫苏的库存有多少？
2025-09-11 14:44:29.465 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:44:29.466 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:44:29.466 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 449)
2025-09-11 14:44:29.466 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': '901846', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiNmU4ZWI1ZTUtMmU4NS00YTFmLTljM2ItNzJjM2YxMzJmYjk4IiwiaWF0IjoxNzU3NTcyOTQ5LCJleHAiOjE3NTc1NzM1NDl9.fxhIBYkb-OW_L8juEY77sI66gOS1IlIdJ4xNpTIy4oQ', 'Signature': '86ba6f9f925d44b4125c5fbce4b33433', 'Message': '%E4%BA%A7%E5%93%81%E6%8F%8F%E8%BF%B0%E4%B8%BA%E7%B4%AB%E8%8B%8F%E7%9A%84%E5%BA%93%E5%AD%98%E6%9C%89%E5%A4%9A%E5%B0%91%EF%BC%9F'}
2025-09-11 14:44:36.798 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:44:36.807 | d64d038f104849888133c5e827a1c4c3 | ERROR    | apps.module_business.service.business_service:search_data_from_sql:154 - 执行sql出错: (oracledb.exceptions.DatabaseError) ORA-00904: "BAS_LOCATION"."LOCATIONID": invalid identifier
Help: https://docs.oracle.com/error-help/db/ora-00904/
[SQL: SELECT COUNT(*) count FROM ( SELECT      ILL.warehouseId AS 仓库,     ILL.locationId AS 库位,     ILL.lotNum AS 批次号,     ILL.traceId AS 跟踪号,     ILL.customerId AS 货主,     ILL.sku AS 产品代码,     BS.skuDescr1 AS 产品描述,     ILA.lotatt01 AS 生产日期,     ILA.lotatt02 AS 失效日期,     ILA.lotatt03 AS 入库日期,     ILA.lotatt08 AS 质量状态,     SUM(ILL.qty) AS 库存数量,     SUM(ILL.qty - ILL.qtyAllocated + ILL.qtyRpIn - ILL.qtyRpOut + ILL.qtyMvIn - ILL.qtyMvOut - ILL.qtyOnHold) AS 可用数量 FROM      INV_LOT_LOC_ID ILL LEFT JOIN      BAS_SKU BS ON ILL.organizationId = BS.organizationId                 AND ILL.customerId = BS.customerId                 AND ILL.sku = BS.sku LEFT JOIN      BAS_LOCATION BL ON ILL.organizationId = BAS_LOCATION.organizationId                      AND ILL.locationId = BAS_LOCATION.locationId LEFT JOIN      INV_LOT_ATT ILA ON ILL.organizationId = ILA.organizationId                      AND ILL.lotNum = ILA.lotNum WHERE      ILL.warehouseId = 'WH01'     AND ILL.organizationId = 'HHYY'     AND BS.skuDescr1 = '紫苏' GROUP BY      ILL.warehouseId,      ILL.locationId,      ILL.lotNum,      ILL.traceId,      ILL.customerId,      ILL.sku,      BS.skuDescr1,      ILA.lotatt01,      ILA.lotatt02,      ILA.lotatt03,      ILA.lotatt08 ) t]
(Background on this error at: https://sqlalche.me/e/20/4xp6)
2025-09-11 14:44:36.808 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:118 - --- Leave node: Data Query ---
2025-09-11 14:44:36.809 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:44:36.810 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 14:44:36.812 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:44:36.812 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:44:36.812 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:306 - --- Leave node: Combine Data ---
2025-09-11 14:44:36.815 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:44:36.826 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 145 ---
2025-09-11 14:44:36.835 | d64d038f104849888133c5e827a1c4c3 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 146 ---
2025-09-11 14:44:36.836 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:44:36.949 | d64d038f104849888133c5e827a1c4c3 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:44:53.115 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:44:53.116 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:44:53.244 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:44:53.254 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 146 ---
2025-09-11 14:44:53.255 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:44:53.257 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:44:54.337 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 790469be-9c98-4586-b13f-29ded8c51090, Total Tokens: 1919, Prompt Tokens: 1898, Completion Tokens: 21
2025-09-11 14:44:54.347 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:44:54.347 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 790469be-9c98-4586-b13f-29ded8c51090
2025-09-11 14:44:54.350 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:44:54.351 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:44:54.353 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:44:54.353 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:44:54.355 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:44:54.355 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:44:54.382 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:44:54.383 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:44:54.383 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 产品描述为紫苏叶的库存有多少？
2025-09-11 14:44:54.384 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:44:54.384 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:44:54.385 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 458)
2025-09-11 14:44:54.385 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': '901846', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiODU2ZWFjYWEtYzAzNS00MTBiLWEwZjAtYjA4MDc3YTBjYzJhIiwiaWF0IjoxNzU3NTcyOTc0LCJleHAiOjE3NTc1NzM1NzR9.sjxN9ttwEzDN0uRwO8lc4Tu7Dorg6XhTOgPLn3UBtqc', 'Signature': 'bdfb5a3c73c24a88ee2c2349754b041e', 'Message': '%E4%BA%A7%E5%93%81%E6%8F%8F%E8%BF%B0%E4%B8%BA%E7%B4%AB%E8%8B%8F%E5%8F%B6%E7%9A%84%E5%BA%93%E5%AD%98%E6%9C%89%E5%A4%9A%E5%B0%91%EF%BC%9F'}
2025-09-11 14:45:02.517 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:45:02.533 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 0 (<= 1000), 执行全量查询.
2025-09-11 14:45:02.549 | f42bb1152d914aed8b732815d02f0748 | ERROR    | utils.excel_util:generate_excel_file:128 - 尝试生成Excel文件，但查询结果为空
2025-09-11 14:45:02.549 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:125 - --- Leave node: Data Query ---
2025-09-11 14:45:02.551 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:45:02.552 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:74 - --- Data Query Router: Go combine data ---
2025-09-11 14:45:02.556 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:45:02.556 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:45:02.556 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:313 - --- Leave node: Combine Data ---
2025-09-11 14:45:02.559 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:45:02.571 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 147 ---
2025-09-11 14:45:02.581 | f42bb1152d914aed8b732815d02f0748 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 148 ---
2025-09-11 14:45:02.582 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:45:02.689 | f42bb1152d914aed8b732815d02f0748 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:45:25.454 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:45:25.454 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:45:25.587 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:45:25.596 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 148 ---
2025-09-11 14:45:25.596 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:45:25.599 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:45:26.577 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 790469be-9c98-4586-b13f-29ded8c51090, Total Tokens: 1926, Prompt Tokens: 1905, Completion Tokens: 21
2025-09-11 14:45:26.591 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:45:26.591 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 790469be-9c98-4586-b13f-29ded8c51090
2025-09-11 14:45:26.593 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:45:26.593 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:45:26.594 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:45:26.595 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:45:26.597 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:45:26.598 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:45:26.602 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:45:26.602 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:45:26.603 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 产品描述为蟾酥的库存一共有多少？
2025-09-11 14:45:26.604 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:45:26.605 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:45:26.605 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 467)
2025-09-11 14:45:26.606 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': '901846', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiZTc5OGM5NWMtZGVhNC00ZGRkLWFmMzktN2IwMDc5NTk1MzUyIiwiaWF0IjoxNzU3NTczMDA2LCJleHAiOjE3NTc1NzM2MDZ9.zxXDZaaaUU4gTuhskApwFs-vJ12qKbRoiuFjx7RR5ss', 'Signature': '9733703b5d131a6bbebca23544fc9713', 'Message': '%E4%BA%A7%E5%93%81%E6%8F%8F%E8%BF%B0%E4%B8%BA%E8%9F%BE%E9%85%A5%E7%9A%84%E5%BA%93%E5%AD%98%E4%B8%80%E5%85%B1%E6%9C%89%E5%A4%9A%E5%B0%91%EF%BC%9F'}
2025-09-11 14:45:33.746 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:45:33.755 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 95 (<= 1000), 执行全量查询.
2025-09-11 14:45:33.768 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/d2d86222-2859-428a-a21a-f5d2dc377597.xlsx
2025-09-11 14:45:33.797 | a31cc772736d4d0f930ffb966a815512 | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/d2d86222-2859-428a-a21a-f5d2dc377597.xlsx
2025-09-11 14:45:33.799 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:45:33.799 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 14:45:33.801 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 14:45:33.801 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 14:45:33.802 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 14:45:33.803 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 14:45:33.803 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 14:45:33.803 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 14:45:34.503 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 790469be-9c98-4586-b13f-29ded8c51090, Total Tokens: 941, Prompt Tokens: 936, Completion Tokens: 5
2025-09-11 14:45:34.511 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:45:34.512 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 790469be-9c98-4586-b13f-29ded8c51090
2025-09-11 14:45:34.513 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 936, 'total_tokens': 941, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-6b2af911-0133-4ba0-b102-9fdc924ec5a3', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--b82aca2a-4e3e-4f75-9384-eaa94a867596-0' usage_metadata={'input_tokens': 936, 'output_tokens': 5, 'total_tokens': 941, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 14:45:34.514 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 14:45:34.514 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 14:45:34.514 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 库存数量 | 可用数量 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 07-05-001 | LT00000556 | * | HHYY | 3000511 | 蟾酥 | 93.4 | 0 | 2023-06-30 | 2026-06-03 |  | SHPL_合格 |
| WH01 | SORTATION_WH01 | LT00000555 | 00020534 | HHYY | 3000511 | 蟾酥 | 29.5 | 0 | 2023-06-30 | 2026-06-03 |  | SHPL_合格 |
| WH01 | 07-03-039 | LT00000530 | * | HHYY | 3000511 | 蟾酥 | 10 | 9 | 2024-05-07 | 2029-04-11 |  | SHPL_待验 |
| WH01 | 07-03-001 | LT00000530 | * | HHYY | 3000511 | 蟾酥 | 91.1 | 91.1 | 2024-05-07 | 2029-04-11 |  | SHPL_待验 |
| WH01 | 07-03-038 | LT00000530 | * | HHYY | 3000511 | 蟾酥 | 1 | 1 | 2024-05-07 | 2029-04-11 |  | SHPL_待验 |
| WH01 | 07-00-002 | LT00000549 | * | HHYY | 3000511 | 蟾酥 | 9.8 | 9.8 | 2024-05-07 | 2029-04-11 |  | SHPL_待验 |
| WH01 | 22-01-001 | LT00000902 | * | HHYY | 3000511 | 蟾酥 | 10 | 10 | 2023-08-08 | 2028-07-12 |  | SHPL_待验 |
| WH01 | 22-01-001 | LT00001153 | * | HHYY | 3000511 | 蟾酥 | 1.6 | 1.6 | 2023-08-08 | 2028-07-12 |  | SHPL_待验 |
| WH01 | SORTATION_WH01 | LT00001237 | * | HHYY | 3000511 | 蟾酥 | 170.3 | 0 | 2023-08-24 | 2028-07-28 |  | SHPL_待验 |
| WH01 | 07-06-001 | LT00001259 | * | HHYY | 3000511 | 蟾酥 | 40 | 40 |  |  |  |  |
| WH01 | 22-01-002 | LT00001269 | * | HHYY | 3000511 | 蟾酥 | 29.81 | 29.81 | 2024-03-20 | 2029-02-22 |  | SHPL_待验 |
| WH01 | 08-02-029 | LT00001287 | * | HHYY | 3000511 | 蟾酥 | 200 | 200 | 2023-08-30 | 2028-08-03 |  | SHPL_待验 |
| WH01 | 08-07-041 | LT00001287 | * | HHYY | 3000511 | 蟾酥 | 95 | 70 | 2023-08-30 | 2028-08-03 |  | SHPL_待验 |
| WH01 | SORTATION_WH01 | LT00001238 | * | HHYY | 3000511 | 蟾酥 | 59.7 | 0 | 2023-08-24 | 2028-07-28 |  | SHPL_待验 |
| WH01 | 01 | LT00001300 | WWW1 | HHYY | 3000511 | 蟾酥 | 0 | 0 |  |  |  | SHPL_待验 |
| WH01 | STAGE_WH01 | LT00001300 | WWW1 | HHYY | 3000511 | 蟾酥 | 10 | 0 |  |  |  | SHPL_待验 |
| WH01 | 01 | LT00001300 | 07-19-13 | HHYY | 3000511 | 蟾酥 | 0 | 0 |  |  |  | SHPL_待验 |
| WH01 | STAGE_WH01 | LT00001300 | 07-19-13 | HHYY | 3000511 | 蟾酥 | 10 | 0 |  |  |  | SHPL_待验 |
| WH01 | SORTATION_WH01 | LT00001300 | * | HHYY | 3000511 | 蟾酥 | 10 | 0 |  |  |  | SHPL_待验 |
| WH01 | 22-01-005 | LT00001526 | * | HHYY | 3000511 | 蟾酥 | 320 | 320 | 2023-09-19 | 2028-08-23 |  | SHPL_待验 |
2025-09-11 14:45:34.515 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 库存数量 | 可用数量 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 07-05-001 | LT00000556 | * | HHYY | 3000511 | 蟾酥 | 93.4 | 0 | 2023-06-30 | 2026-06-03 |  | SHPL_合格 |
| WH01 | SORTATION_WH01 | LT00000555 | 00020534 | HHYY | 3000511 | 蟾酥 | 29.5 | 0 | 2023-06-30 | 2026-06-03 |  | SHPL_合格 |
| WH01 | 07-03-039 | LT00000530 | * | HHYY | 3000511 | 蟾酥 | 10 | 9 | 2024-05-07 | 2029-04-11 |  | SHPL_待验 |
| WH01 | 07-03-001 | LT00000530 | * | HHYY | 3000511 | 蟾酥 | 91.1 | 91.1 | 2024-05-07 | 2029-04-11 |  | SHPL_待验 |
| WH01 | 07-03-038 | LT00000530 | * | HHYY | 3000511 | 蟾酥 | 1 | 1 | 2024-05-07 | 2029-04-11 |  | SHPL_待验 |
| WH01 | 07-00-002 | LT00000549 | * | HHYY | 3000511 | 蟾酥 | 9.8 | 9.8 | 2024-05-07 | 2029-04-11 |  | SHPL_待验 |
| WH01 | 22-01-001 | LT00000902 | * | HHYY | 3000511 | 蟾酥 | 10 | 10 | 2023-08-08 | 2028-07-12 |  | SHPL_待验 |
| WH01 | 22-01-001 | LT00001153 | * | HHYY | 3000511 | 蟾酥 | 1.6 | 1.6 | 2023-08-08 | 2028-07-12 |  | SHPL_待验 |
| WH01 | SORTATION_WH01 | LT00001237 | * | HHYY | 3000511 | 蟾酥 | 170.3 | 0 | 2023-08-24 | 2028-07-28 |  | SHPL_待验 |
| WH01 | 07-06-001 | LT00001259 | * | HHYY | 3000511 | 蟾酥 | 40 | 40 |  |  |  |  |
| WH01 | 22-01-002 | LT00001269 | * | HHYY | 3000511 | 蟾酥 | 29.81 | 29.81 | 2024-03-20 | 2029-02-22 |  | SHPL_待验 |
| WH01 | 08-02-029 | LT00001287 | * | HHYY | 3000511 | 蟾酥 | 200 | 200 | 2023-08-30 | 2028-08-03 |  | SHPL_待验 |
| WH01 | 08-07-041 | LT00001287 | * | HHYY | 3000511 | 蟾酥 | 95 | 70 | 2023-08-30 | 2028-08-03 |  | SHPL_待验 |
| WH01 | SORTATION_WH01 | LT00001238 | * | HHYY | 3000511 | 蟾酥 | 59.7 | 0 | 2023-08-24 | 2028-07-28 |  | SHPL_待验 |
| WH01 | 01 | LT00001300 | WWW1 | HHYY | 3000511 | 蟾酥 | 0 | 0 |  |  |  | SHPL_待验 |
| WH01 | STAGE_WH01 | LT00001300 | WWW1 | HHYY | 3000511 | 蟾酥 | 10 | 0 |  |  |  | SHPL_待验 |
| WH01 | 01 | LT00001300 | 07-19-13 | HHYY | 3000511 | 蟾酥 | 0 | 0 |  |  |  | SHPL_待验 |
| WH01 | STAGE_WH01 | LT00001300 | 07-19-13 | HHYY | 3000511 | 蟾酥 | 10 | 0 |  |  |  | SHPL_待验 |
| WH01 | SORTATION_WH01 | LT00001300 | * | HHYY | 3000511 | 蟾酥 | 10 | 0 |  |  |  | SHPL_待验 |
| WH01 | 22-01-005 | LT00001526 | * | HHYY | 3000511 | 蟾酥 | 320 | 320 | 2023-09-19 | 2028-08-23 |  | SHPL_待验 | ---
2025-09-11 14:45:34.515 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 14:45:34.517 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 14:45:34.519 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:45:34.519 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:45:34.520 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 14:45:34.522 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:45:34.534 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 149 ---
2025-09-11 14:45:34.544 | a31cc772736d4d0f930ffb966a815512 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 150 ---
2025-09-11 14:45:34.544 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:45:34.666 | a31cc772736d4d0f930ffb966a815512 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 14:47:13.176 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 14:47:13.176 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 14:47:13.315 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 14:47:13.322 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:53 - --- History Init: 已存在历史消息,最近一条消息ID: 150 ---
2025-09-11 14:47:13.322 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:54 - --- Leave node: History Init ---
2025-09-11 14:47:13.324 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 14:47:14.801 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 790469be-9c98-4586-b13f-29ded8c51090, Total Tokens: 3626, Prompt Tokens: 3605, Completion Tokens: 21
2025-09-11 14:47:14.809 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:47:14.810 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 790469be-9c98-4586-b13f-29ded8c51090
2025-09-11 14:47:14.811 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 14:47:14.811 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 14:47:14.812 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 14:47:14.812 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 14:47:14.814 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 14:47:14.814 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 14:47:14.819 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 14:47:14.819 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 14:47:14.820 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 现在仓库里有哪些产品？
2025-09-11 14:47:14.820 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 14:47:14.820 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 14:47:14.820 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 422)
2025-09-11 14:47:14.821 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': '901846', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiYTJiMjNiZGUtY2VkOS00OGRlLWE0NmUtZGM4YjQxZjkzNTg5IiwiaWF0IjoxNzU3NTczMTE0LCJleHAiOjE3NTc1NzM3MTR9.gpewIukjsUOkugOT5ci2GnLhLvilGgfDhCx1dSbQgJM', 'Signature': '6a5d4df5a141588e94ed9afc338e4f82', 'Message': '%E7%8E%B0%E5%9C%A8%E4%BB%93%E5%BA%93%E9%87%8C%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BA%A7%E5%93%81%EF%BC%9F'}
2025-09-11 14:47:23.644 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 14:47:23.664 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_business.service.business_service:search_data_from_sql:125 - 数据量为 2126 (> 1000), 执行流式查询.
2025-09-11 14:47:24.273 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | utils.excel_util:generate_excel_file_using_stream:203 - 成功生成Excel文件: /app/excel_file/768adb7b-c565-4b79-b885-93ce92591e35.xlsx
2025-09-11 14:47:24.274 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 14:47:24.275 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 14:47:24.277 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 14:47:24.278 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 14:47:24.279 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 14:47:24.280 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 14:47:24.280 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 14:47:24.280 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 14:47:25.105 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 790469be-9c98-4586-b13f-29ded8c51090, Total Tokens: 997, Prompt Tokens: 992, Completion Tokens: 5
2025-09-11 14:47:25.113 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 14:47:25.114 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 790469be-9c98-4586-b13f-29ded8c51090
2025-09-11 14:47:25.115 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 992, 'total_tokens': 997, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-ad81d35e-e0f1-4b7b-9dbe-7dae61d825a9', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--f14374e7-5dfd-48da-8e57-7aa9dc6c33a4-0' usage_metadata={'input_tokens': 992, 'output_tokens': 5, 'total_tokens': 997, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 14:47:25.115 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 14:47:25.116 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 14:47:25.116 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共20行）:
| 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | T0007 | LT00001981 | * | HHYY | 1011000111 | 麝香保心丸,42丸/盒,300盒/箱,每丸重22.5mg |  |  |  | SHPL_待验 | 22 | 22 |
| WH01 | 17-00-002 | LT00079517 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2024-12-04 |  | SHPL_待验 | 10 | 10 |
| WH01 | TEST022 | LT00001134 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 |  | SHPL_待验 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 100 | 0 |
| WH01 | 17-00-002 | LT00003416 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2025-02-20 |  |  | 10 | 10 |
| WH01 | 17-00-001 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 0 | 287000 |
| WH01 | 01 | LT00002000 | 05-16-01 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 0 | 0 |
| WH01 | 17-00-002 | LT00003338 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2024-11-22 |  |  | 10 | 10 |
| WH01 | 03-02-038 | LT00002178 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 100 | 100 |
| WH01 | TEST009 | LT00000151 | BCR00066 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 0 | 6000 |
| WH01 | TEST009 | LT00000151 | BCR00065 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 0 | 6000 |
| WH01 | TEST009 | LT00000151 | BCR00081 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 0 | 6000 |
| WH01 | 01002006 | LT00000167 | BCR00051-ZK2 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-03-21 | SHPL_待验 | 4000 | 4000 |
| WH01 | 01004004 | LT00000151 | BCR00080 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 6000 | 0 |
| WH01 | 001 | LT00000494 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2020-03-03 | 2023-02-28 | 2023-02-27 | SHPL_合格 | 9900 | 9900 |
| WH01 | 01005005 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 0 | 6000 |
| WH01 | 001 | LT00000147 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-04-13 | 2024-05-31 | 2023-03-02 | 有效 | 20 | 0 |
| WH01 | 01003006 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 6000 | 0 |
| WH01 | 01010001 | LT00000227 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09 | SHPL_合格 | 6000 | 0 |
| WH01 | 01030006 | LT00000226 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09 | SHPL_合格 | 0 | 6000 |
2025-09-11 14:47:25.116 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 | 库存数量 | 可用数量 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | T0007 | LT00001981 | * | HHYY | 1011000111 | 麝香保心丸,42丸/盒,300盒/箱,每丸重22.5mg |  |  |  | SHPL_待验 | 22 | 22 |
| WH01 | 17-00-002 | LT00079517 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-08-01 | 2024-12-04 |  | SHPL_待验 | 10 | 10 |
| WH01 | TEST022 | LT00001134 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-01-27 | 2023-12-31 |  | SHPL_待验 | 0 | 0 |
| WH01 | STAGE_WH01 | LT00001735 | 24011801 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2023-12-06 | 2026-11-30 |  | SHPL_待验 | 100 | 0 |
| WH01 | 17-00-002 | LT00003416 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2025-02-20 |  |  | 10 | 10 |
| WH01 | 17-00-001 | LT00001952 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-04-05 | 2024-03-31 | 2023-02-08 | SHPL_待处理 | 0 | 287000 |
| WH01 | 01 | LT00002000 | 05-16-01 | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 0 | 0 |
| WH01 | 17-00-002 | LT00003338 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2024-05-31 | 2024-11-22 |  |  | 10 | 10 |
| WH01 | 03-02-038 | LT00002178 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg |  |  |  |  | 100 | 100 |
| WH01 | TEST009 | LT00000151 | BCR00066 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 0 | 6000 |
| WH01 | TEST009 | LT00000151 | BCR00065 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 0 | 6000 |
| WH01 | TEST009 | LT00000151 | BCR00081 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 0 | 6000 |
| WH01 | 01002006 | LT00000167 | BCR00051-ZK2 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-03-21 | SHPL_待验 | 4000 | 4000 |
| WH01 | 01004004 | LT00000151 | BCR00080 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 6000 | 0 |
| WH01 | 001 | LT00000494 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2020-03-03 | 2023-02-28 | 2023-02-27 | SHPL_合格 | 9900 | 9900 |
| WH01 | 01005005 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 0 | 6000 |
| WH01 | 001 | LT00000147 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2021-04-13 | 2024-05-31 | 2023-03-02 | 有效 | 20 | 0 |
| WH01 | 01003006 | LT00000151 | BCR00064 | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg | 2023-02-22 | 2025-09-30 |  | SHPL_待验 | 6000 | 0 |
| WH01 | 01010001 | LT00000227 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09 | SHPL_合格 | 6000 | 0 |
| WH01 | 01030006 | LT00000226 | * | HHYY | 1011000131 | 麝香保心丸,60丸/盒,300盒/箱,每丸重22.5mg |  |  | 2023-05-09 | SHPL_合格 | 0 | 6000 | ---
2025-09-11 14:47:25.116 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 14:47:25.120 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 14:47:25.122 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 14:47:25.122 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 14:47:25.123 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 14:47:25.126 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 14:47:25.137 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 151 ---
2025-09-11 14:47:25.152 | 050fbaad29e749579bb6cdb619a59cb2 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 152 ---
2025-09-11 14:47:25.153 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 14:47:25.287 | 050fbaad29e749579bb6cdb619a59cb2 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 16:13:40.184 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 16:13:40.186 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 16:13:40.262 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 16:13:40.281 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 16:13:40.282 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 16:13:40.283 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 16:13:41.320 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 09567900-71cb-447c-a4b7-ac1a78869c61, Total Tokens: 849, Prompt Tokens: 828, Completion Tokens: 21
2025-09-11 16:13:41.331 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 16:13:41.331 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 09567900-71cb-447c-a4b7-ac1a78869c61
2025-09-11 16:13:41.333 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 16:13:41.333 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 16:13:41.334 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 16:13:41.335 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 16:13:41.337 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 16:13:41.337 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 16:16:14.510 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 16:16:14.511 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 16:16:14.573 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 16:16:14.590 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 16:16:14.590 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 16:16:14.592 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 16:16:15.442 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 9b502a32-f695-4e99-a118-4e761a64b6ea, Total Tokens: 848, Prompt Tokens: 827, Completion Tokens: 21
2025-09-11 16:16:15.450 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 16:16:15.451 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 9b502a32-f695-4e99-a118-4e761a64b6ea
2025-09-11 16:16:15.452 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 16:16:15.453 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 16:16:15.454 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 16:16:15.454 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 16:16:15.457 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 16:16:15.457 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 16:22:17.869 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.chat_controller:do_chat:101 - Current chat is interrupted? ()
2025-09-11 16:22:17.869 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.chat_controller:do_chat:135 - --- Starting new conversation or continuing non-interrupted flow ---
2025-09-11 16:22:17.941 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:24 - --- Enter node: History Init ---
2025-09-11 16:22:17.955 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.graph.node.history_init:history_init_node:70 - --- History Init: 未存在历史消息,新增Conversation结果: True ---
2025-09-11 16:22:17.955 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.history_init:history_init_node:71 - --- Leave node: History Init ---
2025-09-11 16:22:17.957 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:24 - --- Enter node: Main Agent ---
2025-09-11 16:22:19.257 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 3fabbf5f-cc1f-40c0-b957-ab4b55ee01a6, Total Tokens: 849, Prompt Tokens: 828, Completion Tokens: 21
2025-09-11 16:22:19.268 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 16:22:19.268 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 3fabbf5f-cc1f-40c0-b957-ab4b55ee01a6
2025-09-11 16:22:19.270 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.graph.node.agent:main_agent:55 - --- Main Agent: AI返回结果: {'intent': 'DATA_QUERY', 'generate_chart': False} ---
2025-09-11 16:22:19.271 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.agent:main_agent:56 - --- Leave node: Main Agent ---
2025-09-11 16:22:19.272 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.routing:main_router:18 - --- Main Router: Deciding next step ---
2025-09-11 16:22:19.272 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.graph.node.routing:main_router:22 - --- Main Router: Go data query ---
2025-09-11 16:22:19.274 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:34 - --- Enter node: Data Query ---
2025-09-11 16:22:19.274 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:42 - Generator chart: False
2025-09-11 16:22:19.303 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 16:22:19.303 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 16:22:19.304 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 质量状态为SHPL_不合格产品代码为1011000112的物料有多少库存
2025-09-11 16:22:19.304 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 16:22:19.305 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 16:22:19.305 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 528)
2025-09-11 16:22:19.305 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'ZHANGXY', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiOWU3ODkyMTUtNzBjMy00MmNjLWI4ZDYtOGUxOTg1NzVlMTRlIiwiaWF0IjoxNzU3NTc4ODE5LCJleHAiOjE3NTc1Nzk0MTl9.Oi368eE8IvhhnMX56MDkLmOdrYP0mA3jsFrEX-mE0vY', 'Signature': 'b1c28add7af0903775ca1b3b93c84164', 'Message': '%E8%B4%A8%E9%87%8F%E7%8A%B6%E6%80%81%E4%B8%BASHPL_%E4%B8%8D%E5%90%88%E6%A0%BC%E4%BA%A7%E5%93%81%E4%BB%A3%E7%A0%81%E4%B8%BA1011000112%E7%9A%84%E7%89%A9%E6%96%99%E6%9C%89%E5%A4%9A%E5%B0%91%E5%BA%93%E5%AD%98'}
2025-09-11 16:22:27.093 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 16:22:27.114 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 4 (<= 1000), 执行全量查询.
2025-09-11 16:22:27.134 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/d0f503a6-d884-4dfb-8c88-28d6cbd0d558.xlsx
2025-09-11 16:22:27.148 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/d0f503a6-d884-4dfb-8c88-28d6cbd0d558.xlsx
2025-09-11 16:22:27.150 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 16:22:27.150 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 16:22:27.153 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 16:22:27.153 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 16:22:27.154 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 16:22:27.155 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 16:22:27.156 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 16:22:27.156 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 16:22:28.048 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 3fabbf5f-cc1f-40c0-b957-ab4b55ee01a6, Total Tokens: 986, Prompt Tokens: 981, Completion Tokens: 5
2025-09-11 16:22:28.055 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 16:22:28.055 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 3fabbf5f-cc1f-40c0-b957-ab4b55ee01a6
2025-09-11 16:22:28.056 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 981, 'total_tokens': 986, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-9a2f2947-ff2c-4839-b2b1-7ab5678d52de', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--ff9f9598-decc-4d84-bf97-716eca725681-0' usage_metadata={'input_tokens': 981, 'output_tokens': 5, 'total_tokens': 986, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 16:22:28.057 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 16:22:28.057 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 16:22:28.058 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共4行）:
| 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 1 | 0 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 0 | 0 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 19764 | 0 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 |
| WH01 | 0 | 0 | 01039006 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 |
2025-09-11 16:22:28.058 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 1 | 0 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 0 | 0 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 19764 | 0 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 |
| WH01 | 0 | 0 | 01039006 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 | ---
2025-09-11 16:22:28.058 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 16:22:28.060 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 16:22:28.062 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 16:22:28.063 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 16:22:28.063 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 16:22:28.066 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 16:22:28.077 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 153 ---
2025-09-11 16:22:28.086 | fb5bcdacef7f469bb61cecfec7e82d12 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 154 ---
2025-09-11 16:22:28.087 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 16:22:28.233 | fb5bcdacef7f469bb61cecfec7e82d12 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 16:29:09.316 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 16:29:09.317 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 16:29:09.317 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 质量状态为SHPL_不合格产品代码为1011000112的物料有多少库存
2025-09-11 16:29:09.318 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 16:29:09.318 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 16:29:09.318 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 528)
2025-09-11 16:29:09.319 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'ZHANGXY', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiMGUzNGU0OGMtNjE0ZC00Njc2LWI4ODctNGY4MWRiNDQwM2NhIiwiaWF0IjoxNzU3NTc5MjI5LCJleHAiOjE3NTc1Nzk4Mjl9.CiS-Cq7-Af-RnHZD7nBgJ7OCoqzamk11zyzsQXQysa4', 'Signature': 'ad3dabe0a05e62830c7fa5cbacfed007', 'Message': '%E8%B4%A8%E9%87%8F%E7%8A%B6%E6%80%81%E4%B8%BASHPL_%E4%B8%8D%E5%90%88%E6%A0%BC%E4%BA%A7%E5%93%81%E4%BB%A3%E7%A0%81%E4%B8%BA1011000112%E7%9A%84%E7%89%A9%E6%96%99%E6%9C%89%E5%A4%9A%E5%B0%91%E5%BA%93%E5%AD%98'}
2025-09-11 16:29:16.173 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 16:29:16.194 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 4 (<= 1000), 执行全量查询.
2025-09-11 16:29:16.212 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/0737ebda-8915-4b00-ba50-4b2d17914348.xlsx
2025-09-11 16:29:16.227 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/0737ebda-8915-4b00-ba50-4b2d17914348.xlsx
2025-09-11 16:29:16.229 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 16:29:16.229 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 16:29:16.231 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 16:29:16.232 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 16:29:16.233 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 16:29:16.234 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 16:29:16.234 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 16:29:16.234 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 16:29:16.947 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 09567900-71cb-447c-a4b7-ac1a78869c61, Total Tokens: 986, Prompt Tokens: 981, Completion Tokens: 5
2025-09-11 16:29:16.958 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 16:29:16.959 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 09567900-71cb-447c-a4b7-ac1a78869c61
2025-09-11 16:29:16.961 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 981, 'total_tokens': 986, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-8ae36461-0d30-4896-a35b-40d0d05c7db8', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--159a386d-be0c-491e-9710-9f2322df35af-0' usage_metadata={'input_tokens': 981, 'output_tokens': 5, 'total_tokens': 986, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 16:29:16.962 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 16:29:16.962 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 16:29:16.962 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共4行）:
| 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 1 | 0 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 0 | 0 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 19764 | 0 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 |
| WH01 | 0 | 0 | 01039006 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 |
2025-09-11 16:29:16.963 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 1 | 0 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 0 | 0 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 19764 | 0 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 |
| WH01 | 0 | 0 | 01039006 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 | ---
2025-09-11 16:29:16.964 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 16:29:16.966 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 16:29:16.968 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 16:29:16.968 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 16:29:16.969 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 16:29:16.970 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 16:29:16.982 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 155 ---
2025-09-11 16:29:16.990 | ec5687ac01dc453a96667bcc58f6a45b | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 156 ---
2025-09-11 16:29:16.990 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 16:29:17.129 | ec5687ac01dc453a96667bcc58f6a45b | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
2025-09-11 16:31:45.466 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_business.service.luma_service:__init__:23 - LumaService initialized with config: {'luma_base_url': 'https://luma.flux.com.cn:18080', 'luma_sql_url': '/Luma/public/agent', 'luma_chat_url': '/Luma/public/chat', 'luma_secret': '6cf3f231-23n1-7fd3-b9e2-913181ge25u3', 'luma_userid': 'LUMA'}
2025-09-11 16:31:45.467 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.data_query:data_query_node:90 - dialect: Oracle
2025-09-11 16:31:45.467 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_business.service.luma_service:get_sql_from_luma:39 - Getting SQL from Luma with message: 质量状态为SHPL_不合格产品代码为1011000112的物料有多少库存
2025-09-11 16:31:45.468 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:94 - Added body params: {'dialect': 'Oracle'}
2025-09-11 16:31:45.469 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_business.service.luma_service:_create_mon_token:179 - Generated JWT token for user: LUMA
2025-09-11 16:31:45.469 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_business.service.luma_service:_md5:197 - Generated MD5 hash for text (length: 528)
2025-09-11 16:31:45.469 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_business.service.luma_service:_get_message_from_luma:121 - Sending request to Luma with URL: https://luma.flux.com.cn:18080/Luma/public/agent, headers: {'organizationId': 'HHYY', 'currentWarehouseId': 'WH01', 'customerId': '', 'userId': 'ZHANGXY', 'warehouseId': '', 'Content-Type': 'application/json', 'Code': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJNT04iLCJuYW1lIjoiTFVNQSIsIm90aGVyIjoid3V6aGkiLCJ1dWlkIjoiNjFlMGM4N2QtNmIzMi00YTAxLWFiNjgtOTNmMDUwY2RiNWRmIiwiaWF0IjoxNzU3NTc5Mzg1LCJleHAiOjE3NTc1Nzk5ODV9.xmPZmpA_B69wd-q1Ha90Is2tIj09jAhNFlpVYXorxmQ', 'Signature': 'f5683129f5d0613537a486574737eb35', 'Message': '%E8%B4%A8%E9%87%8F%E7%8A%B6%E6%80%81%E4%B8%BASHPL_%E4%B8%8D%E5%90%88%E6%A0%BC%E4%BA%A7%E5%93%81%E4%BB%A3%E7%A0%81%E4%B8%BA1011000112%E7%9A%84%E7%89%A9%E6%96%99%E6%9C%89%E5%A4%9A%E5%B0%91%E5%BA%93%E5%AD%98'}
2025-09-11 16:31:51.776 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_business.service.luma_service:_get_message_from_luma:131 - Successfully got response from Luma, URL: https://luma.flux.com.cn:18080/Luma/public/agent
2025-09-11 16:31:51.781 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_business.service.business_service:search_data_from_sql:103 - 数据量为 4 (<= 1000), 执行全量查询.
2025-09-11 16:31:51.785 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | utils.excel_util:generate_excel_file:135 - 开始生成Excel文件: /app/excel_file/5aa82b81-553c-4274-9746-3af34cb4eb97.xlsx
2025-09-11 16:31:51.794 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | utils.excel_util:generate_excel_file:158 - 成功生成Excel文件: /app/excel_file/5aa82b81-553c-4274-9746-3af34cb4eb97.xlsx
2025-09-11 16:31:51.795 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.routing:data_query_router:59 - --- Data Query Router: Deciding next step ---
2025-09-11 16:31:51.795 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.graph.node.routing:data_query_router:71 - --- Data Query Router: Go parallel process ---
2025-09-11 16:31:51.798 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:202 - --- Enter node: Parallel Process ---
2025-09-11 16:31:51.798 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.data_query:parallel_process_node:203 - --- Leave node: Parallel Process ---
2025-09-11 16:31:51.800 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:148 - --- Enter node: Chart Agent ---
2025-09-11 16:31:51.800 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.graph.node.agent:chart_agent:159 - --- Chart Agent: 意图识别不生成图表! ---
2025-09-11 16:31:51.800 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.agent:chart_agent:160 - --- Leave node: Chart Agent ---
2025-09-11 16:31:51.801 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:217 - --- Enter node: Generate Markdown Table ---
2025-09-11 16:31:52.325 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:39 - LLM executed for chat_id: 9b502a32-f695-4e99-a118-4e761a64b6ea, Total Tokens: 986, Prompt Tokens: 981, Completion Tokens: 5
2025-09-11 16:31:52.333 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:64 - Add token usage ret: is_success=True message='新增成功' result=None
2025-09-11 16:31:52.333 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.middleware.token_usage_callback:on_llm_end:65 - Successfully scheduled token usage db write for chat_id: 9b502a32-f695-4e99-a118-4e761a64b6ea
2025-09-11 16:31:52.334 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:398 - Use llm find sql alias: content='```json\n{}\n```' additional_kwargs={'refusal': None} response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 981, 'total_tokens': 986, 'completion_tokens_details': None, 'prompt_tokens_details': {'audio_tokens': None, 'cached_tokens': 0}}, 'model_name': 'qwen-plus', 'system_fingerprint': None, 'id': 'chatcmpl-4a38086d-4c7f-486f-8f35-ac1e371d49ff', 'service_tier': None, 'finish_reason': 'stop', 'logprobs': None} id='run--5b6f31e9-f0c7-4792-99fd-7e5f7d33381f-0' usage_metadata={'input_tokens': 981, 'output_tokens': 5, 'total_tokens': 986, 'input_token_details': {'cache_read': 0}, 'output_token_details': {}}
2025-09-11 16:31:52.334 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.graph.node.data_query:use_llm_find_sql_alias:402 - Find sql alias: {}
2025-09-11 16:31:52.335 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | utils.markdown_util:format_sql_field_alias:101 - No fields need to jump!
2025-09-11 16:31:52.335 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | utils.markdown_util:format_list_to_markdown:81 - 生成的Markdown表格（共4行）:
| 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 1 | 0 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 0 | 0 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 19764 | 0 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 |
| WH01 | 0 | 0 | 01039006 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 |
2025-09-11 16:31:52.335 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:230 - --- Generate Markdown Table: 生成结果: | 仓库 | 库存数量 | 可用数量 | 库位 | 批次号 | 跟踪号 | 货主 | 产品代码 | 产品描述 | 生产日期 | 失效日期 | 入库日期 | 质量状态 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|
| WH01 | 1 | 0 | STAGE_WH01 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 0 | 0 | TEST022 | LT00001135 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-03 | 2024-02-29 |  | SHPL_不合格 |
| WH01 | 19764 | 0 | 01035002 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 |
| WH01 | 0 | 0 | 01039006 | LT00000092 | * | HHYY | 1011000112 | 麝香保心丸,42丸/盒,450盒/箱,每丸重22.5mg | 2021-03-08 | 2024-02-29 | 2023-02-21 | SHPL_不合格 | ---
2025-09-11 16:31:52.335 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.data_query:generate_markdown_table_node:231 - --- Leave node: Generate Markdown Table ---
2025-09-11 16:31:52.337 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.tool_executor:echarts_tool_executor_node:61 - --- Enter node: ECharts Tool Executor ---
2025-09-11 16:31:52.339 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:247 - --- Enter node: Combine Data ---
2025-09-11 16:31:52.339 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:281 - --- Combine Data: For data query ---
2025-09-11 16:31:52.340 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.data_query:combine_data_node:356 - --- Leave node: Combine Data ---
2025-09-11 16:31:52.341 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:22 - --- Enter node: History Persistent ---
2025-09-11 16:31:52.353 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:51 - --- History Persistent: 新增Human消息获得主键: 157 ---
2025-09-11 16:31:52.362 | d83d1a909c5e4133a5acf2dfc7cdc264 | DEBUG    | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:65 - --- History Persistent: 新增AI消息获得主键: 158 ---
2025-09-11 16:31:52.362 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.graph.node.history_persistent:history_persistent_node:67 - --- Leave node: History Persistent ---
2025-09-11 16:31:52.506 | d83d1a909c5e4133a5acf2dfc7cdc264 | INFO     | apps.module_llm.chat.chat_controller:do_chat:154 - Final output state next: ()
